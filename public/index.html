<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CADalytics Creator Factory</title>
    <meta name="description" content="AI-powered Civil 3D tool generator for LISP routines, drawing templates, and corridor subassemblies.">
    <meta http-equiv="Content-Security-Policy" content="frame-ancestors *;">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --bg-card: #1e293b;
            --bg-hover: #334155;
            --bg-surface: #0f172a;
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --text-muted: #64748b;
            --accent-primary: #3b82f6;
            --accent-secondary: #8b5cf6;
            --accent-success: #10b981;
            --accent-warning: #f59e0b;
            --accent-error: #ef4444;
            --border-primary: #334155;
            --border-secondary: #475569;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.15);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.2);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
            --gradient-primary: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            --gradient-surface: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            --glass-bg: rgba(30, 41, 59, 0.8);
            --glass-border: rgba(203, 213, 225, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            background-image: 
                radial-gradient(at 40% 20%, rgba(59, 130, 246, 0.1) 0px, transparent 50%),
                radial-gradient(at 80% 0%, rgba(139, 92, 246, 0.1) 0px, transparent 50%),
                radial-gradient(at 0% 50%, rgba(16, 185, 129, 0.05) 0px, transparent 50%);
            color: var(--text-primary);
            min-height: 100vh;
            display: grid;
            grid-template-columns: 1fr;
            gap: 24px;
            padding: 24px;
            font-size: 14px;
            line-height: 1.5;
        }

        .main-container {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            box-shadow: var(--shadow-xl);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            background: var(--gradient-primary);
            color: var(--text-primary);
            padding: 20px 24px;
            display: flex;
            align-items: center;
            gap: 16px;
            border-bottom: 1px solid var(--glass-border);
        }

        .header-icon {
            font-size: 32px;
            background: rgba(255, 255, 255, 0.15);
            padding: 12px;
            border-radius: 16px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 20px;
            font-weight: 700;
            letter-spacing: -0.025em;
        }

        .header .status {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            font-weight: 600;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 25px;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            backdrop-filter: blur(10px);
        }

        .theme-toggle {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: var(--text-primary);
            padding: 8px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }

        .theme-toggle:hover {
            background: rgba(255,255,255,0.2);
            transform: rotate(180deg);
        }

        .status-badge::before {
            content: "";
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent-success);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Enhanced animations */
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .option-card, .creator-card, .template-type-card {
            animation: slideInUp 0.6s ease-out forwards;
        }

        .option-card:nth-child(2) { animation-delay: 0.1s; }
        .option-card:nth-child(3) { animation-delay: 0.2s; }
        .option-card:nth-child(4) { animation-delay: 0.3s; }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .page {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-surface);
            z-index: 10;
        }

        .page.active {
            display: flex;
            flex-direction: column;
        }

        .page-header {
            background: var(--gradient-primary);
            color: var(--text-primary);
            padding: 20px 24px;
            display: flex;
            align-items: center;
            gap: 16px;
            border-bottom: 1px solid var(--glass-border);
            backdrop-filter: blur(20px);
        }

        .back-button {
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.2);
            color: var(--text-primary);
            padding: 10px 16px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
        }

        .back-button:hover {
            background: rgba(255,255,255,0.25);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .page-content {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
            background: var(--bg-surface);
        }

        .page-content::-webkit-scrollbar {
            width: 8px;
        }

        .page-content::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: 4px;
        }

        .page-content::-webkit-scrollbar-thumb {
            background: var(--border-primary);
            border-radius: 4px;
        }

        .page-content::-webkit-scrollbar-thumb:hover {
            background: var(--border-secondary);
        }

        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .option-card {
            border: 1px solid var(--border-primary);
            border-radius: 16px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            box-shadow: var(--shadow-md);
            position: relative;
            overflow: hidden;
        }

        .option-card::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-primary);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .option-card:hover {
            border-color: var(--accent-primary);
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(59, 130, 246, 0.15);
            background: var(--bg-card);
        }

        .option-card:hover::before {
            opacity: 1;
        }

        .option-card.selected {
            border-color: var(--accent-primary);
            background: var(--bg-card);
        }

        .option-card.selected::before {
            opacity: 1;
        }

        .option-icon {
            font-size: 36px;
            margin-bottom: 16px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            color: white;
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .option-icon::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            transform: rotate(45deg);
            transition: all 0.5s;
            opacity: 0;
        }

        .option:hover .option-icon::before {
            animation: shimmer 1.5s ease-in-out infinite;
            opacity: 1;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }

        .option-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .option-desc {
            color: var(--text-secondary);
            margin-bottom: 12px;
            line-height: 1.5;
        }

        .option-price {
            font-size: 20px;
            font-weight: 700;
            color: var(--accent-primary);
        }

        .custom-section {
            background: var(--bg-secondary);
            border: 2px dashed var(--border-primary);
            border-radius: 16px;
            padding: 32px;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .custom-input {
            width: 100%;
            max-width: 500px;
            padding: 14px 18px;
            border: 1px solid var(--border-primary);
            border-radius: 12px;
            font-size: 14px;
            margin: 16px 0;
            background: var(--bg-card);
            color: var(--text-primary);
            transition: all 0.3s;
        }

        .custom-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .custom-input::placeholder {
            color: var(--text-muted);
        }

        .custom-button {
            background: var(--gradient-primary);
            color: var(--text-primary);
            border: none;
            padding: 14px 28px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .custom-button::before {
            content: "";
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .custom-button:hover::before {
            left: 100%;
        }

        .custom-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(59, 130, 246, 0.3);
        }

        .selection-summary {
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 16px;
            padding: 24px;
            margin-top: 32px;
            backdrop-filter: blur(10px);
        }

        .proceed-button {
            background: linear-gradient(135deg, var(--accent-success) 0%, #059669 100%);
            color: var(--text-primary);
            border: none;
            padding: 18px 36px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .proceed-button::before {
            content: "";
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .proceed-button:hover::before {
            left: 100%;
        }

        .proceed-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(16, 185, 129, 0.3);
        }

        .detailed-card {
            min-height: 200px;
        }

        .option-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .complexity-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .complexity-badge.basic {
            background: #dcfce7;
            color: #16a34a;
        }

        .complexity-badge.intermediate {
            background: #fef3c7;
            color: #d97706;
        }

        .complexity-badge.advanced {
            background: #fef2f2;
            color: #dc2626;
        }

        .complexity-badge.expert {
            background: #f3e8ff;
            color: #7c3aed;
        }

        .option-features {
            margin: 12px 0;
        }

        .feature-tag {
            display: inline-block;
            background: #eff6ff;
            color: #2563eb;
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 11px;
            margin: 2px 4px 2px 0;
        }

        .spec-tag {
            display: block;
            color: #4b5563;
            font-size: 12px;
            margin: 2px 0;
        }

        .app-tag {
            display: inline-block;
            background: #f0fdf4;
            color: #16a34a;
            padding: 2px 6px;
            border-radius: 6px;
            font-size: 11px;
            margin: 2px 4px 2px 0;
        }

        .option-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #e2e8f0;
        }

        .time-estimate {
            color: #64748b;
            font-size: 12px;
        }

        .specs-section, .applications-section {
            margin: 12px 0;
        }

        .specs-section strong, .applications-section strong {
            display: block;
            color: var(--text-secondary);
            font-size: 13px;
            margin-bottom: 6px;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 14px;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: normal;
            color: var(--text-secondary);
            cursor: pointer;
            transition: color 0.3s;
        }

        .checkbox-group label:hover {
            color: var(--text-primary);
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            border: 2px solid var(--border-primary);
            border-radius: 4px;
            background: var(--bg-card);
            cursor: pointer;
            transition: all 0.3s;
        }

        .checkbox-group input[type="checkbox"]:checked {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
        }

        .form-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .form-section h3 {
            color: var(--text-primary);
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .feature-badge {
            background: var(--accent-primary);
            color: var(--text-primary);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .complexity-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .complexity-basic { background: var(--accent-success); color: var(--text-primary); }
        .complexity-intermediate { background: var(--accent-warning); color: var(--text-primary); }
        .complexity-advanced { background: var(--accent-error); color: var(--text-primary); }
        .complexity-expert { background: var(--accent-secondary); color: var(--text-primary); }

        .template-type-card {
            border: 1px solid var(--border-primary);
            border-radius: 16px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .template-type-card::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-primary);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .template-type-card:hover {
            border-color: var(--accent-primary);
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(59, 130, 246, 0.15);
            background: var(--bg-card);
        }

        .template-type-card:hover::before {
            opacity: 1;
        }

        .template-type-card.selected {
            border-color: var(--accent-primary);
            background: var(--bg-card);
        }

        .template-type-card.selected::before {
            opacity: 1;
        }

        .messages {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
            background: var(--bg-surface);
        }

        .messages::-webkit-scrollbar {
            width: 8px;
        }

        .messages::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: 4px;
        }

        .messages::-webkit-scrollbar-thumb {
            background: var(--border-primary);
            border-radius: 4px;
        }

        .message {
            margin-bottom: 20px;
        }

        .message.assistant {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 20px;
            box-shadow: var(--shadow-md);
        }

        .message.user {
            text-align: right;
        }

        .message.user .message-content {
            display: inline-block;
            background: var(--gradient-primary);
            color: var(--text-primary);
            padding: 14px 20px;
            border-radius: 16px;
            max-width: 70%;
            font-weight: 500;
        }

        .welcome-message {
            margin-bottom: 20px;
        }

        .creator-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 16px;
        }

        .creator-card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: center;
            user-select: none;
            position: relative;
            overflow: hidden;
        }

        .creator-card::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-primary);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .creator-card:hover {
            border-color: var(--accent-primary);
            background: var(--bg-card);
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(59, 130, 246, 0.15);
        }

        .creator-card:hover::before {
            opacity: 1;
        }

        .creator-card:active {
            transform: translateY(-2px);
        }

        .creator-card .icon {
            font-size: 32px;
            margin-bottom: 16px;
            padding: 16px;
            background: var(--gradient-primary);
            border-radius: 16px;
            color: white;
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.3);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .creator-card:hover .icon {
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 12px 30px rgba(59, 130, 246, 0.4);
        }

        .creator-card .title {
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--text-primary);
            font-size: 16px;
        }

        .creator-card .desc {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .cost-estimator-float {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 280px;
            background: var(--glass-bg);
            border: 1px solid var(--border-primary);
            border-radius: 20px;
            padding: 20px;
            backdrop-filter: blur(20px);
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            transition: box-shadow 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: move;
        }

        .cost-estimator-float:hover {
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
        }

        .cost-estimator-float.dragging {
            cursor: grabbing;
            user-select: none;
        }

        .cost-estimator-header {
            cursor: grab;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-primary);
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(147, 51, 234, 0.1) 100%);
            margin: -20px -20px 16px -20px;
            padding: 16px 20px 12px 20px;
            border-radius: 20px 20px 0 0;
            position: relative;
        }

        .cost-estimator-header::before {
            content: '‚ãÆ‚ãÆ';
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            font-size: 14px;
            letter-spacing: 2px;
        }

        .cost-estimator-header:active {
            cursor: grabbing;
        }

        .sidebar {
            display: none; /* Hide original sidebar - only show floating cost estimator */
        }

        .sidebar-section {
            background: var(--bg-card);
            border: 1px solid var(--border-primary);
            border-radius: 16px;
            padding: 20px;
            box-shadow: var(--shadow-md);
            backdrop-filter: blur(10px);
        }

        .sidebar-title {
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-primary);
            font-size: 16px;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
        }

        .cost-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .cost-total {
            border-top: 1px solid var(--border-primary);
            padding-top: 12px;
            margin-top: 12px;
            font-weight: 700;
            font-size: 16px;
            color: var(--text-primary);
        }

        .session-info {
            font-size: 13px;
            color: var(--text-muted);
            line-height: 1.6;
        }

        .session-info strong {
            color: var(--text-secondary);
            font-weight: 600;
        }

        .pricing-guide {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .pricing-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-primary);
        }

        .pricing-item:last-child {
            border-bottom: none;
        }

        .pricing-item span:first-child {
            color: var(--text-secondary);
            font-size: 13px;
        }

        .pricing-item span:last-child {
            color: var(--text-primary);
            font-weight: 600;
            font-size: 14px;
        }

        /* Fix text readability issues */
        .status-indicator {
            width: 8px;
            height: 8px;
            background: var(--accent-success);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .session-status {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .session-status-text {
            color: var(--accent-success);
            font-weight: 600;
            font-size: 13px;
        }

        .session-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 13px;
        }

        .session-item .label {
            color: var(--text-muted);
        }

        .session-item .value {
            color: var(--text-primary);
            font-weight: 500;
        }

        /* Enhanced cost display */
        .cost-summary {
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .cost-display {
            text-align: center;
        }

        .cost-amount {
            font-size: 32px;
            font-weight: 800;
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 50%, #06b6d4 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            animation: glow 2s ease-in-out infinite alternate;
            margin-bottom: 4px;
        }

        @keyframes glow {
            from { filter: brightness(1); }
            to { filter: brightness(1.2); }
        }

        /* Enhanced Professional Graphics */
        .enhanced-card {
            position: relative;
            overflow: hidden;
        }

        .enhanced-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .enhanced-card:hover::before {
            left: 100%;
        }

        /* Professional Send Button Enhancement */
        .send-button {
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%) !important;
            border: none !important;
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4) !important;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
            border-radius: 50% !important;
            width: 48px !important;
            height: 48px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
        }

        .send-button:hover {
            transform: translateY(-2px) scale(1.1) rotate(15deg) !important;
            box-shadow: 0 12px 30px rgba(59, 130, 246, 0.6) !important;
        }

        .send-button svg {
            transition: transform 0.3s ease !important;
        }

        .send-button:hover svg {
            transform: translateX(2px) !important;
        }

        .cost-label {
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .cost-breakdown {
            margin-top: 16px;
        }

        .cost-breakdown-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            font-size: 13px;
        }

        .cost-breakdown-item .item-count {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }

        .cost-breakdown-item .item-price {
            color: var(--text-primary);
            font-weight: 600;
        }

        .pricing-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }

        .input-container {
            padding: 20px;
            border-top: 1px solid #e2e8f0;
            background: var(--bg-card);
            color: var(--text-primary);
        }

        .input-row {
            display: flex;
            gap: 12px;
        }

        #messageInput {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #cbd5e1;
            border-radius: 24px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
        }

        #messageInput:focus {
            border-color: #2563eb;
        }

        #sendButton {
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        #sendButton:hover:not(:disabled) {
            background: #1d4ed8;
        }

        #sendButton:disabled {
            background: #94a3b8;
            cursor: not-allowed;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #64748b;
            font-size: 14px;
        }

        .loading.show {
            display: block;
        }

        @media (max-width: 1024px) {
            body {
                grid-template-columns: 1fr;
                grid-template-rows: 1fr auto;
            }
            
            .sidebar {
                grid-row: 2;
                flex-direction: row;
                overflow-x: auto;
            }
            
            .sidebar-section {
                min-width: 250px;
            }
        }

        @media (max-width: 768px) {
            .creator-grid {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="header">
            <span class="header-icon">üèóÔ∏è</span>
            <h1>üèóÔ∏è CADalytics Creator Factory</h1>
            <div class="status">
                <div class="status-badge">AI Online</div>
                <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Theme">üåô</button>
            </div>
        </div>
        
        <div class="chat-container">
            <!-- Main Chat Page -->
            <div id="mainPage" class="page active">
                <div class="messages" id="messages">
                    <div class="message assistant">
                        <div class="welcome-message">
                            <strong>üëã Welcome to the CADalytics Creator Factory!</strong> I'm here to help you build exactly what you need for Civil 3D.
                            <br><br>
                            <em>What are you looking to create today?</em>
                        </div>
                        
                        <div class="creator-grid">
                            <div class="creator-card enhanced-card" onclick="openPage('lispPage')">
                                <div class="icon">‚ö°</div>
                                <div class="title">LISP Creator</div>
                                <div class="desc">Intelligent automation & custom routines</div>
                            </div>
                            <div class="creator-card enhanced-card" onclick="openPage('templatePage')">
                                <div class="icon">üìê</div>
                                <div class="title">Template Creator</div>
                                <div class="desc">Professional drawing standards & layouts</div>
                            </div>
                            <div class="creator-card enhanced-card" onclick="openPage('subassemblyPage')">
                                <div class="icon">üõ£Ô∏è</div>
                                <div class="title">Subassembly Selector</div>
                                <div class="desc">Advanced corridor design components</div>
                            </div>
                            <div class="creator-card enhanced-card" onclick="selectCreator('custom')">
                                <div class="icon">üéØ</div>
                                <div class="title">Custom Solutions</div>
                                <div class="desc">Tailored engineering solutions & consulting</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="loading" id="loading">
                    Processing your message...
                </div>
                
                <div class="input-container">
                    <div class="input-row">
                        <input type="text" id="messageInput" placeholder="Or type your request here..." />
                        <button id="sendButton" class="send-button" onclick="sendMessage()">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="22" y1="2" x2="11" y2="13"></line>
                                <polygon points="22,2 15,22 11,13 2,9"></polygon>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- LISP Creator Page -->
            <div id="lispPage" class="page">
                <div class="page-header">
                    <button class="back-button" onclick="goBack()">‚Üê Back</button>
                    <span class="header-icon">‚ö°</span>
                    <h1>LISP Creator</h1>
                </div>
                <div class="page-content">
                    <h2 style="margin-bottom: 16px;">Choose Your LISP Routines</h2>
                    <p style="color: #64748b; margin-bottom: 24px;">Select from our pre-built automation tools or request a custom solution</p>
                    
                    <div class="options-grid" id="lispOptions">
                        <!-- LISP options will be populated here -->
                    </div>
                    
                    <div class="custom-section">
                        <div class="option-icon">üéØ</div>
                        <h3>Custom LISP Request</h3>
                        <p style="color: #64748b; margin: 12px 0;">Need something specific? Describe your automation needs</p>
                        <input type="text" class="custom-input" id="customLispInput" placeholder="Describe your custom LISP requirement...">
                        <button class="custom-button" onclick="requestCustomLisp()">Request Custom LISP</button>
                    </div>
                    
                    <div class="selection-summary" id="lispSummary" style="display: none;">
                        <h3>Your LISP Selection</h3>
                        <div id="lispSelectionList"></div>
                        <button class="proceed-button" onclick="completeLispSelection()">Complete LISP Selection</button>
                    </div>
                </div>
            </div>

            <!-- Subassembly Selector Page -->
            <div id="subassemblyPage" class="page">
                <div class="page-header">
                    <button class="back-button" onclick="goBack()">‚Üê Back</button>
                    <span class="header-icon">üõ£Ô∏è</span>
                    <h1>Subassembly Selector</h1>
                </div>
                <div class="page-content">
                    <h2 style="margin-bottom: 16px; color: var(--text-primary);">Corridor Components</h2>
                    <p style="color: var(--text-secondary); margin-bottom: 24px;">Build your corridor with our library of subassemblies</p>
                    
                    <div class="options-grid" id="subassemblyOptions">
                        <!-- Subassembly options will be populated here -->
                    </div>
                    
                    <div class="custom-section">
                        <div class="option-icon">üîß</div>
                        <h3>Custom Subassembly</h3>
                        <p style="color: var(--text-secondary); margin: 12px 0;">Need a specialized corridor component?</p>
                        <input type="text" class="custom-input" id="customSubInput" placeholder="Describe your custom subassembly requirement...">
                        <button class="custom-button" onclick="requestCustomSubassembly()">Request Custom Subassembly</button>
                    </div>
                    
                    <div class="selection-summary" id="subassemblySummary" style="display: none;">
                        <h3>Your Corridor Design</h3>
                        <div id="subassemblySelectionList"></div>
                        <button class="proceed-button" onclick="completeSubassemblySelection()">Complete Corridor Design</button>
                    </div>
                </div>
            </div>

            <!-- Template Creator Page -->
            <div id="templatePage" class="page">
                <div class="page-header">
                    <button class="back-button" onclick="goBack()">‚Üê Back</button>
                    <span class="header-icon">üìê</span>
                    <h1>Template Creator</h1>
                </div>
                <div class="page-content">
                    <h2 style="margin-bottom: 16px; color: var(--text-primary);">Professional Drawing Templates</h2>
                    <p style="color: var(--text-secondary); margin-bottom: 24px;">Create standardized templates with industry-compliant layers, styles, and configurations</p>
                    
                    <!-- Template Type Selection -->
                    <div style="margin-bottom: 32px;">
                        <h3 style="margin-bottom: 16px; color: var(--text-primary);">1. Select Template Type</h3>
                        <div class="options-grid" id="templateTypes">
                            <!-- Template types will be populated here -->
                        </div>
                    </div>

                    <!-- Configuration Panel -->
                    <div id="templateConfig" style="display: none; background: var(--bg-secondary); border: 1px solid var(--border-primary); border-radius: 12px; padding: 24px; margin-bottom: 24px;">
                        <h3 style="margin-bottom: 16px; color: var(--text-primary);">2. Configure Template</h3>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                            <div>
                                <h4 style="color: var(--text-primary); margin-bottom: 12px;">Drawing Setup</h4>
                                <div class="form-group">
                                    <label>Sheet Size:</label>
                                    <select class="custom-input" id="sheetSize">
                                        <option value="ANSI A (8.5x11)">ANSI A (8.5" x 11")</option>
                                        <option value="ANSI B (11x17)">ANSI B (11" x 17")</option>
                                        <option value="ANSI C (17x22)">ANSI C (17" x 22")</option>
                                        <option value="ANSI D (22x34)" selected>ANSI D (22" x 34")</option>
                                        <option value="ANSI E (34x44)">ANSI E (34" x 44")</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Scale:</label>
                                    <select class="custom-input" id="drawingScale">
                                        <option value="1=10">1" = 10'</option>
                                        <option value="1=20" selected>1" = 20'</option>
                                        <option value="1=30">1" = 30'</option>
                                        <option value="1=40">1" = 40'</option>
                                        <option value="1=50">1" = 50'</option>
                                        <option value="1=100">1" = 100'</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Units:</label>
                                    <select class="custom-input" id="units">
                                        <option value="feet" selected>Feet</option>
                                        <option value="meters">Meters</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div>
                                <h4 style="color: var(--text-primary); margin-bottom: 12px;">Standards Compliance</h4>
                                <div class="checkbox-group">
                                    <label><input type="checkbox" checked> CAD Standards</label>
                                    <label><input type="checkbox" checked> Layer Naming Convention</label>
                                    <label><input type="checkbox"> MUTCD Compliance</label>
                                    <label><input type="checkbox"> State DOT Standards</label>
                                    <label><input type="checkbox"> ADA Compliance</label>
                                </div>
                            </div>
                        </div>

                        <div style="margin-top: 24px;">
                            <h4 style="color: var(--text-primary); margin-bottom: 12px;">Layer Configuration</h4>
                            <div id="layerConfig">
                                <!-- Dynamic layer configuration based on template type -->
                            </div>
                        </div>

                        <div style="margin-top: 24px;">
                            <h4 style="color: var(--text-primary); margin-bottom: 12px;">Title Block Information</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                <input type="text" class="custom-input" placeholder="Company Name" id="companyName">
                                <input type="text" class="custom-input" placeholder="Project Name" id="projectName">
                                <input type="text" class="custom-input" placeholder="Engineer/Designer" id="designer">
                                <input type="text" class="custom-input" placeholder="Project Number" id="projectNumber">
                            </div>
                        </div>
                    </div>

                    <!-- Custom Template Section -->
                    <div class="custom-section">
                        <div class="option-icon">‚öôÔ∏è</div>
                        <h3>Custom Template Requirements</h3>
                        <p style="color: var(--text-secondary); margin: 12px 0;">Need a specialized template? Describe your requirements</p>
                        <textarea class="custom-input" rows="4" placeholder="Describe specific requirements, standards, or special elements needed..."></textarea>
                        <button class="custom-button" onclick="requestCustomTemplate()">Request Custom Template</button>
                    </div>

                    <!-- Template Summary -->
                    <div class="selection-summary" id="templateSummary" style="display: none;">
                        <h3>Template Configuration Summary</h3>
                        <div id="templateDetails"></div>
                        <button class="proceed-button" onclick="generateTemplate()">Generate Template</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Cost Estimator -->
    <div class="cost-estimator-float" id="costEstimator">
        <div class="cost-estimator-header">
            <div class="sidebar-title">üíé Cost Estimator</div>
        </div>
        <div class="cost-summary">
            <div class="cost-display">
                <div class="cost-amount" id="totalCost">$0.00</div>
                <div class="cost-label">Estimated Total</div>
            </div>
        </div>
        <div class="cost-breakdown" id="costBreakdown" style="display: none;">
            <div class="cost-breakdown-item" id="lispBreakdown" style="display: none;">
                <span>LISP Routines<span class="item-count" id="lispCount">0</span></span>
                <span class="item-price" id="lispCost">$0.00</span>
            </div>
            <div class="cost-breakdown-item" id="templateBreakdown" style="display: none;">
                <span>Templates<span class="item-count" id="templateCount">0</span></span>
                <span class="item-price" id="templateCost">$0.00</span>
            </div>
            <div class="cost-breakdown-item" id="subBreakdown" style="display: none;">
                <span>Subassemblies<span class="item-count" id="subCount">0</span></span>
                <span class="item-price" id="subCost">$0.00</span>
            </div>
            <div class="cost-breakdown-item" id="customBreakdown" style="display: none;">
                <span>Custom Solutions<span class="item-count" id="customCount">0</span></span>
                <span class="item-price" id="customCost">$0.00</span>
            </div>
        </div>
    </div>

    <script>
        const messagesContainer = document.getElementById('messages');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const loading = document.getElementById('loading');
        let sessionId = null;
        let currentIntent = 'custom';
        let selections = {
            lisp: 0,
            template: 0,
            subassembly: 0,
            custom: 0
        };
        let selectedItems = {
            lisp: [],
            subassembly: [],
            template: []
        };

        // Initialize session
        async function initSession() {
            try {
                const response = await fetch('/api/sessions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ uid: `user_${Date.now()}` })
                });
                const session = await response.json();
                sessionId = session.id;
                updateSessionDisplay();
            } catch (error) {
                console.error('Failed to initialize session:', error);
                sessionId = 'xc89glFsVjUe'; // Fallback
                updateSessionDisplay();
            }
        }

        // Update session display
        function updateSessionDisplay() {
            // Safe element updates with null checks
            const sessionDisplay = document.getElementById('sessionDisplay');
            if (sessionDisplay) {
                sessionDisplay.textContent = sessionId ? sessionId.slice(0, 12) + '...' : 'Loading...';
            }
            
            const intentDisplay = document.getElementById('intentDisplay');
            if (intentDisplay) {
                intentDisplay.textContent = currentIntent.charAt(0).toUpperCase() + currentIntent.slice(1);
            }
            
            // Calculate totals
            const totalSelections = selections.lisp + selections.template + selections.subassembly + selections.custom;
            const selectionsCount = document.getElementById('selectionsCount');
            if (selectionsCount) {
                selectionsCount.textContent = totalSelections;
            }
            
            // Calculate costs
            const costs = {
                lisp: selections.lisp * 5,
                template: selections.template * 30,
                subassembly: selections.subassembly * 20,
                custom: selections.custom * 10
            };
            
            const total = Object.values(costs).reduce((sum, cost) => sum + cost, 0);
            
            // Update main cost display
            const totalCostElement = document.getElementById('totalCost');
            if (totalCostElement) {
                totalCostElement.textContent = `$${total.toFixed(2)}`;
            }
            
            // Show/hide breakdown based on selections
            const breakdown = document.getElementById('costBreakdown');
            if (breakdown) {
                if (totalSelections > 0) {
                    breakdown.style.display = 'block';
                    
                    // Update breakdown items safely
                    const updateBreakdownItem = (type, count, cost) => {
                        const breakdownElement = document.getElementById(`${type}Breakdown`);
                        const countElement = document.getElementById(`${type}Count`);
                        const costElement = document.getElementById(`${type}Cost`);
                        
                        if (breakdownElement && countElement && costElement) {
                            if (count > 0) {
                                breakdownElement.style.display = 'flex';
                                countElement.textContent = count;
                                costElement.textContent = `$${cost.toFixed(2)}`;
                            } else {
                                breakdownElement.style.display = 'none';
                            }
                        }
                    };
                    
                    updateBreakdownItem('lisp', selections.lisp, costs.lisp);
                    updateBreakdownItem('template', selections.template, costs.template);
                    updateBreakdownItem('sub', selections.subassembly, costs.subassembly);
                    updateBreakdownItem('custom', selections.custom, costs.custom);
                } else {
                    breakdown.style.display = 'none';
                }
            }
        }

        // Page navigation
        function openPage(pageId) {
            console.log('Opening page:', pageId);
            
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Show selected page
            document.getElementById(pageId).classList.add('active');
            
            // Initialize page content
            if (pageId === 'lispPage') {
                initLispPage();
                currentIntent = 'lisp';
            } else if (pageId === 'subassemblyPage') {
                initSubassemblyPage();
                currentIntent = 'subassembly';
            } else if (pageId === 'templatePage') {
                initTemplatePage();
                currentIntent = 'template';
            }
            
            updateSessionDisplay();
        }

        function goBack() {
            // Show main page
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById('mainPage').classList.add('active');
            currentIntent = 'custom';
            updateSessionDisplay();
        }

        // Select creator (for custom only now)
        async function selectCreator(type) {
            console.log('Creator selected:', type);
            
            currentIntent = type;
            updateSessionDisplay();
            
            if (type === 'custom') {
                addMessage("I understand you have custom requirements. Let me help you create a specialized solution for your needs.", 'assistant');
            }
            
            // Send to AI for processing
            try {
                await sendToAI(`I want to use the ${type} creator`);
            } catch (error) {
                console.log('AI processing optional, continuing with local response');
            }
        }

        // Initialize LISP page
        function initLispPage() {
            const lispCategories = {
                "Drawing Automation": [
                    { name: "Smart Line Tools", desc: "Intelligent line drawing with automatic labeling, dimensions, and layer assignment", features: ["Auto-dimensioning", "Smart snapping", "Layer detection"], complexity: "Basic", time: "1-2 days", price: "$15" },
                    { name: "Block Manager Pro", desc: "Advanced block insertion with rotation, scaling, and attribute automation", features: ["Auto-rotate", "Bulk insertion", "Attribute sync"], complexity: "Intermediate", time: "2-3 days", price: "$25" },
                    { name: "Text Formatter Suite", desc: "Comprehensive text manipulation including style conversion and batch updates", features: ["Style conversion", "Batch editing", "Format sync"], complexity: "Basic", time: "1 day", price: "$12" },
                    { name: "Layer Wizard", desc: "Complete layer management system with standards compliance and auto-creation", features: ["Standards check", "Auto-creation", "Cleanup tools"], complexity: "Advanced", time: "3-4 days", price: "$35" }
                ],
                "Survey & Data": [
                    { name: "Point Cloud Processor", desc: "Import, process, and label survey points with coordinate transformation", features: ["Coordinate transform", "Auto-labeling", "Quality check"], complexity: "Advanced", time: "4-5 days", price: "$45" },
                    { name: "Traverse Calculator", desc: "Complete traverse calculations with closure analysis and error distribution", features: ["Closure analysis", "Error distribution", "Report generation"], complexity: "Expert", time: "5-7 days", price: "$65" },
                    { name: "Boundary Processor", desc: "Automated boundary line creation from legal descriptions and coordinates", features: ["Legal desc. parsing", "Auto-closure", "Area calculation"], complexity: "Advanced", time: "3-4 days", price: "$40" }
                ],
                "Civil Design": [
                    { name: "Surface Generator Pro", desc: "Advanced surface creation with breaklines, boundaries, and quality control", features: ["Breakline detection", "Quality control", "Contour generation"], complexity: "Expert", time: "5-6 days", price: "$55" },
                    { name: "Alignment Assistant", desc: "Horizontal and vertical alignment tools with design standards checking", features: ["Standards check", "Curve optimization", "Report tools"], complexity: "Advanced", time: "4-5 days", price: "$50" },
                    { name: "Profile Optimizer", desc: "Automated profile creation and optimization with cut/fill analysis", features: ["Cut/fill analysis", "Grade optimization", "Volume calculation"], complexity: "Expert", time: "6-7 days", price: "$70" },
                    { name: "Corridor Designer", desc: "Complete corridor design automation with subassembly placement", features: ["Auto-placement", "Design standards", "3D visualization"], complexity: "Expert", time: "7-10 days", price: "$85" }
                ],
                "Utilities & Analysis": [
                    { name: "Utility Mapper", desc: "Automated utility line placement with conflict detection and labeling", features: ["Conflict detection", "Depth analysis", "Auto-labeling"], complexity: "Intermediate", time: "2-3 days", price: "$30" },
                    { name: "Drainage Calculator", desc: "Comprehensive drainage analysis with pipe sizing and flow calculations", features: ["Pipe sizing", "Flow analysis", "HGL calculation"], complexity: "Advanced", time: "4-5 days", price: "$48" },
                    { name: "Grade Checker", desc: "Automated grade checking and compliance verification for accessibility", features: ["ADA compliance", "Grade analysis", "Report generation"], complexity: "Intermediate", time: "2-3 days", price: "$28" }
                ]
            };

            let optionsHtml = '';
            Object.entries(lispCategories).forEach(([category, options]) => {
                optionsHtml += `
                    <div style="margin-bottom: 32px;">
                        <h3 style="color: #1e293b; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 2px solid #e2e8f0;">${category}</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 16px;">
                            ${options.map(lisp => `
                                <div class="option-card detailed-card" onclick="selectLispOption('${lisp.name}', '${lisp.price}')">
                                    <div class="option-header">
                                        <div class="option-icon">‚ö°</div>
                                        <div class="complexity-badge ${lisp.complexity.toLowerCase()}">${lisp.complexity}</div>
                                    </div>
                                    <div class="option-title">${lisp.name}</div>
                                    <div class="option-desc">${lisp.desc}</div>
                                    <div class="option-features">
                                        ${lisp.features.map(feature => `<span class="feature-tag">‚úì ${feature}</span>`).join('')}
                                    </div>
                                    <div class="option-footer">
                                        <div class="time-estimate">‚è±Ô∏è ${lisp.time}</div>
                                        <div class="option-price">${lisp.price}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });

            document.getElementById('lispOptions').innerHTML = optionsHtml;
        }

        // Initialize Subassembly page
        function initSubassemblyPage() {
            const subassemblyCategories = {
                "Curbs & Gutters": [
                    { name: "Standard Curb & Gutter", desc: "6-inch concrete curb with 18-inch gutter section", specs: ["6\" curb height", "18\" gutter width", "Reinforced concrete"], applications: ["Urban streets", "Residential"], price: "$25" },
                    { name: "Mountable Curb", desc: "4-inch low-profile curb for emergency vehicle access", specs: ["4\" curb height", "Sloped face", "Emergency access"], applications: ["Fire lanes", "Parking areas"], price: "$18" },
                    { name: "Barrier Curb", desc: "8-inch high barrier curb for traffic separation", specs: ["8\" curb height", "Vertical face", "Traffic barrier"], applications: ["Highways", "Medians"], price: "$22" },
                    { name: "Integral Curb", desc: "Curb cast monolithically with pavement", specs: ["Integral construction", "No joint", "Continuous"], applications: ["Highways", "High-speed roads"], price: "$28" }
                ],
                "Drainage Systems": [
                    { name: "V-Ditch Rural", desc: "Trapezoidal drainage ditch for rural applications", specs: ["3:1 side slopes", "Variable depth", "Grass lined"], applications: ["Rural roads", "Highways"], price: "$15" },
                    { name: "Box Culvert", desc: "Reinforced concrete box culvert for drainage", specs: ["Reinforced concrete", "Custom sizing", "Headwalls included"], applications: ["Stream crossings", "Large flow"], price: "$45" },
                    { name: "Swale Bio-retention", desc: "Engineered bioswale for stormwater management", specs: ["Engineered soil", "Native plants", "Overflow structure"], applications: ["Green infrastructure", "Urban areas"], price: "$35" }
                ],
                "Pedestrian Infrastructure": [
                    { name: "ADA Compliant Sidewalk", desc: "5-foot concrete sidewalk meeting ADA requirements", specs: ["5' width minimum", "2% max cross slope", "ADA compliant"], applications: ["Urban areas", "Transit stops"], price: "$20" },
                    { name: "Multi-Use Path", desc: "12-foot asphalt path for bikes and pedestrians", specs: ["12' width", "Asphalt surface", "Striped"], applications: ["Parks", "Trails"], price: "$30" },
                    { name: "Bike Lane Separated", desc: "Protected bike lane with physical barrier", specs: ["6' lane width", "Physical barrier", "Striping"], applications: ["Urban streets", "Bike networks"], price: "$25" }
                ],
                "Barriers & Walls": [
                    { name: "Guardrail W-Beam", desc: "Standard W-beam guardrail system", specs: ["W-beam rail", "Steel posts", "Reflectors"], applications: ["Highways", "Bridge approaches"], price: "$32" },
                    { name: "Sound Wall Concrete", desc: "Precast concrete sound barrier wall", specs: ["Precast panels", "Custom height", "Aesthetic options"], applications: ["Residential areas", "Highways"], price: "$65" },
                    { name: "Retaining Wall MSE", desc: "Mechanically stabilized earth retaining wall", specs: ["Modular blocks", "Geogrid reinforcement", "Tiered design"], applications: ["Cut/fill transitions", "Bridge approaches"], price: "$55" },
                    { name: "Jersey Barrier", desc: "Portable concrete traffic barrier", specs: ["Standard profile", "Interlocking", "Reflective tape"], applications: ["Work zones", "Temporary barriers"], price: "$28" }
                ],
                "Specialized Elements": [
                    { name: "Median Island", desc: "Raised concrete median with landscaping", specs: ["Variable width", "Drainage", "Landscape ready"], applications: ["Intersections", "Boulevard"], price: "$40" },
                    { name: "Bus Stop Pad", desc: "Concrete boarding area for transit stops", specs: ["ADA compliant", "Non-slip surface", "Integrated drainage"], applications: ["Bus routes", "Transit centers"], price: "$35" },
                    { name: "Truck Apron", desc: "Reinforced concrete apron for truck turning", specs: ["Heavy duty concrete", "Reinforced", "Scored surface"], applications: ["Intersections", "Industrial"], price: "$42" }
                ]
            };

            let optionsHtml = '';
            Object.entries(subassemblyCategories).forEach(([category, options]) => {
                optionsHtml += `
                    <div style="margin-bottom: 32px;">
                        <h3 style="color: #1e293b; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 2px solid #e2e8f0;">${category}</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 16px;">
                            ${options.map(sub => `
                                <div class="option-card detailed-card" onclick="selectSubassembly('${sub.name}', '${sub.price}')">
                                    <div class="option-header">
                                        <div class="option-icon">üèóÔ∏è</div>
                                        <div class="option-price">${sub.price}</div>
                                    </div>
                                    <div class="option-title">${sub.name}</div>
                                    <div class="option-desc">${sub.desc}</div>
                                    <div class="specs-section">
                                        <strong>Specifications:</strong>
                                        ${sub.specs.map(spec => `<span class="spec-tag">‚Ä¢ ${spec}</span>`).join('')}
                                    </div>
                                    <div class="applications-section">
                                        <strong>Applications:</strong>
                                        ${sub.applications.map(app => `<span class="app-tag">${app}</span>`).join('')}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });

            document.getElementById('subassemblyOptions').innerHTML = optionsHtml;
        }

        // Initialize Template page
        function initTemplatePage() {
            const templateTypes = [
                { 
                    name: "Site Plan", 
                    icon: "üèóÔ∏è", 
                    desc: "Comprehensive site development plans with utilities, grading, and landscaping",
                    layers: ["Existing Conditions", "Proposed Buildings", "Utilities", "Grading", "Landscaping", "Parking"],
                    price: "$45"
                },
                { 
                    name: "Road Design", 
                    icon: "üõ£Ô∏è", 
                    desc: "Highway and street design with alignments, profiles, and cross-sections",
                    layers: ["Centerline", "ROW", "Pavement", "Shoulders", "Drainage", "Utilities", "Traffic Control"],
                    price: "$55"
                },
                { 
                    name: "Survey Plan", 
                    icon: "üìê", 
                    desc: "Boundary surveys, topographic surveys, and ALTA/NSPS land title surveys",
                    layers: ["Boundary", "Topography", "Structures", "Utilities", "Easements", "Annotations"],
                    price: "$35"
                },
                { 
                    name: "Subdivision", 
                    icon: "üèòÔ∏è", 
                    desc: "Residential and commercial subdivision layouts with lots and infrastructure",
                    layers: ["Lots", "Streets", "Utilities", "Drainage", "Open Space", "Phasing"],
                    price: "$50"
                },
                { 
                    name: "Utility Plan", 
                    icon: "‚ö°", 
                    desc: "Water, sewer, storm, electric, and telecommunications utility design",
                    layers: ["Water", "Sewer", "Storm", "Electric", "Communications", "Conflicts"],
                    price: "$40"
                },
                { 
                    name: "Construction", 
                    icon: "üîß", 
                    desc: "Construction documents with details, specifications, and sequencing",
                    layers: ["Demolition", "Construction", "Details", "Sections", "Notes", "Sequencing"],
                    price: "$42"
                }
            ];

            document.getElementById('templateTypes').innerHTML = templateTypes.map(template => `
                <div class="template-type-card" onclick="selectTemplateType('${template.name}', ${JSON.stringify(template).replace(/"/g, '&quot;')})">
                    <div style="font-size: 48px; margin-bottom: 12px;">${template.icon}</div>
                    <div class="option-title">${template.name}</div>
                    <div class="option-desc" style="margin: 12px 0;">${template.desc}</div>
                    <div class="option-price">${template.price}</div>
                </div>
            `).join('');
        }

        let selectedTemplate = null;

        // Select template type
        function selectTemplateType(templateName, templateData) {
            selectedTemplate = templateData;
            
            // Update UI
            document.querySelectorAll('.template-type-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.target.closest('.template-type-card').classList.add('selected');
            
            // Show configuration panel
            document.getElementById('templateConfig').style.display = 'block';
            
            // Populate layer configuration
            populateLayerConfig(templateData.layers);
            
            // Update summary
            updateTemplateSummary();
        }

        // Populate layer configuration
        function populateLayerConfig(layers) {
            const layerConfig = document.getElementById('layerConfig');
            layerConfig.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                    ${layers.map(layer => `
                        <label style="display: flex; align-items: center; gap: 8px; padding: 8px; background: var(--bg-card); color: var(--text-primary); border-radius: 6px; border: 1px solid var(--border-primary);">
                            <input type="checkbox" checked> ${layer}
                        </label>
                    `).join('')}
                </div>
                <div style="margin-top: 16px;">
                    <input type="text" class="custom-input" placeholder="Add custom layer..." style="margin-bottom: 8px;">
                    <button type="button" class="custom-button" onclick="addCustomLayer()">Add Layer</button>
                </div>
            `;
        }

        // Add custom layer
        function addCustomLayer() {
            const input = document.querySelector('#layerConfig input[type="text"]');
            const layerName = input.value.trim();
            if (!layerName) return;
            
            const layerGrid = document.querySelector('#layerConfig div');
            layerGrid.innerHTML += `
                <label style="display: flex; align-items: center; gap: 8px; padding: 8px; background: var(--bg-card); color: var(--text-primary); border-radius: 6px; border: 1px solid var(--border-primary);">
                    <input type="checkbox" checked> ${layerName}
                </label>
            `;
            input.value = '';
            updateTemplateSummary();
        }

        // Update template summary
        function updateTemplateSummary() {
            if (!selectedTemplate) return;
            
            const summary = document.getElementById('templateSummary');
            const details = document.getElementById('templateDetails');
            
            const sheetSize = document.getElementById('sheetSize')?.value || 'ANSI D (22" x 34")';
            const scale = document.getElementById('drawingScale')?.value || '1" = 20\'';
            const units = document.getElementById('units')?.value || 'feet';
            
            const checkedLayers = Array.from(document.querySelectorAll('#layerConfig input[type="checkbox"]:checked'))
                .map(cb => cb.parentElement.textContent.trim());
            
            details.innerHTML = `
                <div style="background: var(--bg-card); color: var(--text-primary); border: 1px solid var(--border-primary); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                    <h4>Template: ${selectedTemplate.name}</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 12px;">
                        <div>
                            <strong>Drawing Setup:</strong><br>
                            Sheet Size: ${sheetSize}<br>
                            Scale: ${scale}<br>
                            Units: ${units}
                        </div>
                        <div>
                            <strong>Layers (${checkedLayers.length}):</strong><br>
                            ${checkedLayers.slice(0, 4).join(', ')}${checkedLayers.length > 4 ? '...' : ''}
                        </div>
                    </div>
                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e2e8f0;">
                        <strong>Total Price: ${selectedTemplate.price}</strong>
                    </div>
                </div>
            `;
            
            summary.style.display = 'block';
        }

        // Generate template
        function generateTemplate() {
            if (!selectedTemplate) return;
            
            selections.template++;
            updateSessionDisplay();
            
            goBack();
            addMessage(`Excellent! I've generated your ${selectedTemplate.name} template with ${document.querySelectorAll('#layerConfig input[type="checkbox"]:checked').length} layers. Your professional drawing template is ready for use.`, 'assistant', [
                'Download template file',
                'View layer specifications',
                'Create additional templates',
                'Get implementation guide'
            ]);
        }

        // Request custom template
        function requestCustomTemplate() {
            const requirements = document.querySelector('.custom-section textarea').value.trim();
            if (!requirements) return;
            
            selections.template++;
            updateSessionDisplay();
            
            goBack();
            addMessage(`Custom Template Request: "${requirements}"`, 'user');
            addMessage(`Perfect! I'll create a custom template based on your requirements: "${requirements}". Our team will design this specialized template with all necessary layers, standards, and configurations.`, 'assistant', [
                'Provide more specifications',
                'Review similar templates',
                'Get development timeline',
                'Submit this request'
            ]);
        }

        // Select LISP option
        function selectLispOption(lispName, lispPrice) {
            selections.lisp++;
            selectedItems.lisp.push({name: lispName, price: lispPrice});
            updateSessionDisplay();
            updateLispSummary();
        }

        // Select subassembly
        function selectSubassembly(subName, subPrice) {
            selections.subassembly++;
            selectedItems.subassembly.push({name: subName, price: subPrice});
            updateSessionDisplay();
            updateSubassemblySummary();
        }

        // Update LISP summary
        function updateLispSummary() {
            const summary = document.getElementById('lispSummary');
            const list = document.getElementById('lispSelectionList');
            
            if (selectedItems.lisp.length > 0) {
                summary.style.display = 'block';
                list.innerHTML = selectedItems.lisp.map(item => `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px; padding: 8px; background: var(--bg-card); color: var(--text-primary); border: 1px solid var(--border-primary); border-radius: 6px;">
                        <span>${item.name}</span>
                        <span style="font-weight: 600; color: var(--accent-primary);">${item.price}</span>
                    </div>
                `).join('');
            }
        }

        // Update Subassembly summary
        function updateSubassemblySummary() {
            const summary = document.getElementById('subassemblySummary');
            const list = document.getElementById('subassemblySelectionList');
            
            if (selectedItems.subassembly.length > 0) {
                summary.style.display = 'block';
                list.innerHTML = selectedItems.subassembly.map(item => `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px; padding: 8px; background: var(--bg-card); color: var(--text-primary); border: 1px solid var(--border-primary); border-radius: 6px;">
                        <span>${item.name}</span>
                        <span style="font-weight: 600; color: var(--accent-primary);">${item.price}</span>
                    </div>
                `).join('');
            }
        }

        // Complete selections
        function completeLispSelection() {
            goBack();
            addMessage(`Excellent! I've completed your LISP selection with ${selectedItems.lisp.length} routines. Your automation tools are ready for development.`, 'assistant', [
                'View my complete order',
                'Add more tools',
                'Proceed to checkout',
                'Get delivery timeline'
            ]);
        }

        function completeSubassemblySelection() {
            goBack();
            addMessage(`Perfect! Your corridor design is complete with ${selectedItems.subassembly.length} components. Your subassemblies are ready for deployment.`, 'assistant', [
                'Review corridor design',
                'Add more components',
                'Download assembly files',
                'Get installation guide'
            ]);
        }

        // Request custom LISP
        function requestCustomLisp() {
            const customRequest = document.getElementById('customLispInput').value.trim();
            if (!customRequest) return;
            
            selections.lisp++;
            selectedItems.lisp.push({name: `Custom: ${customRequest}`, price: "TBD"});
            updateSessionDisplay();
            updateLispSummary();
            document.getElementById('customLispInput').value = '';
        }

        // Request custom subassembly
        function requestCustomSubassembly() {
            const customRequest = document.getElementById('customSubInput').value.trim();
            if (!customRequest) return;
            
            selections.subassembly++;
            selectedItems.subassembly.push({name: `Custom: ${customRequest}`, price: "TBD"});
            updateSessionDisplay();
            updateSubassemblySummary();
            document.getElementById('customSubInput').value = '';
        }

        // Send to AI helper
        async function sendToAI(message) {
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message,
                        sessionId,
                        userId: 'web_user'
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.intent) {
                        currentIntent = result.intent;
                        updateSessionDisplay();
                    }
                }
            } catch (error) {
                console.log('AI processing failed, using local fallback');
            }
        }

        // Send message
        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;

            addMessage(message, 'user');
            messageInput.value = '';
            sendButton.disabled = true;
            loading.classList.add('show');

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message,
                        sessionId,
                        userId: 'web_user'
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    currentIntent = result.intent || currentIntent;
                    updateSessionDisplay();
                    addMessage(result.message, 'assistant', result.suggestions);
                } else {
                    addMessage('Sorry, I encountered an error. Please try again.', 'assistant');
                }
            } catch (error) {
                console.error('Error sending message:', error);
                addMessage('Connection error. Please check your internet connection and try again.', 'assistant');
            } finally {
                loading.classList.remove('show');
                sendButton.disabled = false;
                messageInput.focus();
            }
        }

        // Add message to chat
        function addMessage(content, sender, suggestions = []) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            if (sender === 'user') {
                messageDiv.innerHTML = `<div class="message-content">${content}</div>`;
            } else {
                let suggestionsHtml = '';
                if (suggestions && suggestions.length > 0) {
                    suggestionsHtml = `
                        <div style="margin-top: 12px;">
                            ${suggestions.map(s => `
                                <button onclick="sendSuggestion('${s}')" 
                                        style="background: #f1f5f9; border: 1px solid #cbd5e1; border-radius: 20px; 
                                               padding: 6px 12px; margin: 4px; font-size: 12px; cursor: pointer; 
                                               transition: all 0.2s;"
                                        onmouseover="this.style.background='#e2e8f0'"
                                        onmouseout="this.style.background='#f1f5f9'">
                                    ${s}
                                </button>
                            `).join('')}
                        </div>
                    `;
                }
                
                messageDiv.innerHTML = `
                    <div style="padding: 16px; background: var(--bg-card); color: var(--text-primary); border: 1px solid var(--border-primary); border-radius: 12px;">
                        ${content}
                        ${suggestionsHtml}
                    </div>
                `;
            }
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Send suggestion
        function sendSuggestion(text) {
            messageInput.value = text;
            sendMessage();
        }

        // Event listeners
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Dark mode toggle functionality
        let darkMode = true; // Default to dark mode

        function toggleTheme() {
            darkMode = !darkMode;
            const themeToggle = document.querySelector('.theme-toggle');
            
            if (darkMode) {
                themeToggle.textContent = 'üåô';
                themeToggle.title = 'Switch to Light Mode';
                // Reset to dark mode (default CSS variables)
                location.reload();
            } else {
                themeToggle.textContent = '‚òÄÔ∏è';
                themeToggle.title = 'Switch to Dark Mode';
                // Apply light mode
                document.documentElement.style.setProperty('--bg-primary', '#f8fafc');
                document.documentElement.style.setProperty('--bg-secondary', '#ffffff');
                document.documentElement.style.setProperty('--bg-card', '#ffffff');
                document.documentElement.style.setProperty('--bg-surface', '#f8fafc'); 
                document.documentElement.style.setProperty('--text-primary', '#1e293b');
                document.documentElement.style.setProperty('--text-secondary', '#475569');
                document.documentElement.style.setProperty('--text-muted', '#94a3b8');
                document.documentElement.style.setProperty('--border-primary', '#e2e8f0');
                document.documentElement.style.setProperty('--glass-bg', 'rgba(255, 255, 255, 0.8)');
                document.documentElement.style.setProperty('--glass-border', 'rgba(0, 0, 0, 0.1)');
                
                // Update body background for light mode
                document.body.style.backgroundImage = `
                    radial-gradient(at 40% 20%, rgba(59, 130, 246, 0.05) 0px, transparent 50%),
                    radial-gradient(at 80% 0%, rgba(139, 92, 246, 0.05) 0px, transparent 50%),
                    radial-gradient(at 0% 50%, rgba(16, 185, 129, 0.03) 0px, transparent 50%)
                `;
            }
        }

        // Enhanced card animations and professional features
        function addCardAnimations() {
            const cards = document.querySelectorAll('.option-card, .creator-card, .template-type-card');
            cards.forEach((card, index) => {
                card.style.animationDelay = `${index * 0.1}s`;
                
                // Add enhanced hover effects
                card.addEventListener('mouseenter', () => {
                    if (!card.classList.contains('selected')) {
                        card.style.transform = 'translateY(-6px) scale(1.02)';
                    }
                });
                
                card.addEventListener('mouseleave', () => {
                    if (!card.classList.contains('selected')) {
                        card.style.transform = 'translateY(0) scale(1)';
                    }
                });
            });
        }

        // Professional search functionality 
        function filterOptions(searchTerm) {
            const cards = document.querySelectorAll('.option-card, .creator-card');
            cards.forEach(card => {
                const title = card.querySelector('.card-title, .title, h4, h3')?.textContent.toLowerCase() || '';
                const desc = card.querySelector('.card-desc, .desc, p')?.textContent.toLowerCase() || '';
                const matches = title.includes(searchTerm.toLowerCase()) || desc.includes(searchTerm.toLowerCase());
                
                if (matches || searchTerm === '') {
                    card.style.display = '';
                    card.style.animation = 'fadeIn 0.3s ease-out';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        // Initialize professional features
        function initProfessionalFeatures() {
            setTimeout(() => {
                addCardAnimations();
                
                // Add any search functionality
                const searchBar = document.querySelector('.search-bar');
                if (searchBar) {
                    searchBar.addEventListener('input', (e) => filterOptions(e.target.value));
                }
                
                // Add enhanced button interactions
                const buttons = document.querySelectorAll('.custom-button, .proceed-button, .back-button');
                buttons.forEach(button => {
                    button.addEventListener('click', function() {
                        this.style.transform = 'scale(0.98)';
                        setTimeout(() => {
                            this.style.transform = '';
                        }, 150);
                    });
                });
            }, 100);
        }

        // Initialize
        initSession();
        messageInput.focus();
        updateSessionDisplay();
        initProfessionalFeatures();

        // Make cost estimator draggable
        function makeDraggable() {
            const costEstimator = document.getElementById('costEstimator');
            const header = costEstimator.querySelector('.cost-estimator-header');
            let isDragging = false;
            let currentX;
            let currentY;
            let initialX;
            let initialY;
            let xOffset = 0;
            let yOffset = 0;

            header.addEventListener('mousedown', dragStart);
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', dragEnd);

            function dragStart(e) {
                initialX = e.clientX - xOffset;
                initialY = e.clientY - yOffset;

                if (e.target === header || header.contains(e.target)) {
                    isDragging = true;
                    costEstimator.classList.add('dragging');
                }
            }

            function drag(e) {
                if (isDragging) {
                    e.preventDefault();
                    currentX = e.clientX - initialX;
                    currentY = e.clientY - initialY;

                    xOffset = currentX;
                    yOffset = currentY;

                    // Keep within viewport bounds
                    const rect = costEstimator.getBoundingClientRect();
                    const maxX = window.innerWidth - rect.width;
                    const maxY = window.innerHeight - rect.height;
                    
                    currentX = Math.max(0, Math.min(currentX, maxX));
                    currentY = Math.max(0, Math.min(currentY, maxY));

                    costEstimator.style.transform = `translate(${currentX}px, ${currentY}px)`;
                    costEstimator.style.right = 'auto';
                    costEstimator.style.top = 'auto';
                    costEstimator.style.left = '0';
                }
            }

            function dragEnd() {
                isDragging = false;
                costEstimator.classList.remove('dragging');
            }
        }

        makeDraggable();
    </script>
</body>
</html>