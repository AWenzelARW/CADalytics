<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CADalytics Creator Factory</title>
    <meta name="description" content="AI-powered Civil 3D tool generator for LISP routines, drawing templates, and corridor subassemblies.">
    <meta http-equiv="Content-Security-Policy" content="frame-ancestors *;">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --bg-card: #1e293b;
            --bg-hover: #334155;
            --bg-surface: #0f172a;
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --text-muted: #64748b;
            --accent-primary: #3b82f6;
            --accent-secondary: #8b5cf6;
            --accent-success: #10b981;
            --accent-warning: #f59e0b;
            --accent-error: #ef4444;
            --border-primary: #334155;
            --border-secondary: #475569;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.15);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.2);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
            --gradient-primary: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            --gradient-surface: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            --glass-bg: rgba(30, 41, 59, 0.8);
            --glass-border: rgba(203, 213, 225, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            background-image: 
                radial-gradient(at 40% 20%, rgba(59, 130, 246, 0.1) 0px, transparent 50%),
                radial-gradient(at 80% 0%, rgba(139, 92, 246, 0.1) 0px, transparent 50%),
                radial-gradient(at 0% 50%, rgba(16, 185, 129, 0.05) 0px, transparent 50%);
            color: var(--text-primary);
            min-height: 100vh;
            display: grid;
            grid-template-columns: 1fr;
            gap: 24px;
            padding: 24px;
            font-size: 14px;
            line-height: 1.5;
        }

        .main-container {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            box-shadow: var(--shadow-xl);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            background: var(--gradient-primary);
            color: var(--text-primary);
            padding: 20px 24px;
            display: flex;
            align-items: center;
            gap: 16px;
            border-bottom: 1px solid var(--glass-border);
        }

        .header-icon {
            font-size: 32px;
            background: rgba(255, 255, 255, 0.15);
            padding: 12px;
            border-radius: 16px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 20px;
            font-weight: 700;
            letter-spacing: -0.025em;
        }

        .header .status {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            font-weight: 600;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 25px;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            backdrop-filter: blur(10px);
        }

        .theme-toggle {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: var(--text-primary);
            padding: 8px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }

        .theme-toggle:hover {
            background: rgba(255,255,255,0.2);
            transform: rotate(180deg);
        }

        .status-badge::before {
            content: "";
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent-success);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Enhanced animations */
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .option-card, .creator-card, .template-type-card {
            animation: slideInUp 0.6s ease-out forwards;
        }

        .option-card:nth-child(2) { animation-delay: 0.1s; }
        .option-card:nth-child(3) { animation-delay: 0.2s; }
        .option-card:nth-child(4) { animation-delay: 0.3s; }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .page {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-surface);
            z-index: 10;
        }

        .page.active {
            display: flex;
            flex-direction: column;
        }

        .page-header {
            background: var(--gradient-primary);
            color: var(--text-primary);
            padding: 20px 24px;
            display: flex;
            align-items: center;
            gap: 16px;
            border-bottom: 1px solid var(--glass-border);
            backdrop-filter: blur(20px);
        }

        .back-button {
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.2);
            color: var(--text-primary);
            padding: 10px 16px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
        }

        .back-button:hover {
            background: rgba(255,255,255,0.25);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .page-content {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
            background: var(--bg-surface);
        }

        .page-content::-webkit-scrollbar {
            width: 8px;
        }

        .page-content::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: 4px;
        }

        .page-content::-webkit-scrollbar-thumb {
            background: var(--border-primary);
            border-radius: 4px;
        }

        .page-content::-webkit-scrollbar-thumb:hover {
            background: var(--border-secondary);
        }

        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .option-card {
            border: 1px solid var(--border-primary);
            border-radius: 16px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            box-shadow: var(--shadow-md);
            position: relative;
            overflow: hidden;
        }

        .option-card::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-primary);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .option-card:hover {
            border-color: var(--accent-primary);
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(59, 130, 246, 0.15);
            background: var(--bg-card);
        }

        .option-card:hover::before {
            opacity: 1;
        }

        .option-card.selected {
            border-color: var(--accent-primary);
            background: var(--bg-card);
        }

        .option-card.selected::before {
            opacity: 1;
        }

        .option-icon {
            font-size: 36px;
            margin-bottom: 16px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            color: white;
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .option-icon::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            transform: rotate(45deg);
            transition: all 0.5s;
            opacity: 0;
        }

        .option:hover .option-icon::before {
            animation: shimmer 1.5s ease-in-out infinite;
            opacity: 1;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }

        .option-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .option-desc {
            color: var(--text-secondary);
            margin-bottom: 12px;
            line-height: 1.5;
        }

        .option-price {
            font-size: 20px;
            font-weight: 700;
            color: var(--accent-primary);
        }

        .custom-section {
            background: var(--bg-secondary);
            border: 2px dashed var(--border-primary);
            border-radius: 16px;
            padding: 32px;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .custom-input {
            width: 100%;
            max-width: 500px;
            padding: 14px 18px;
            border: 1px solid var(--border-primary);
            border-radius: 12px;
            font-size: 14px;
            margin: 16px 0;
            background: var(--bg-card);
            color: var(--text-primary);
            transition: all 0.3s;
        }

        .custom-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .custom-input::placeholder {
            color: var(--text-muted);
        }

        .custom-button {
            background: var(--gradient-primary);
            color: var(--text-primary);
            border: none;
            padding: 14px 28px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .custom-button::before {
            content: "";
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .custom-button:hover::before {
            left: 100%;
        }

        .custom-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(59, 130, 246, 0.3);
        }

        .selection-summary {
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 16px;
            padding: 24px;
            margin-top: 32px;
            backdrop-filter: blur(10px);
        }

        .proceed-button {
            background: linear-gradient(135deg, var(--accent-success) 0%, #059669 100%);
            color: var(--text-primary);
            border: none;
            padding: 18px 36px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .proceed-button::before {
            content: "";
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .proceed-button:hover::before {
            left: 100%;
        }

        .proceed-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(16, 185, 129, 0.3);
        }

        .detailed-card {
            min-height: 200px;
        }

        .option-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .complexity-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .complexity-badge.basic {
            background: #dcfce7;
            color: #16a34a;
        }

        .complexity-badge.intermediate {
            background: #fef3c7;
            color: #d97706;
        }

        .complexity-badge.advanced {
            background: #fef2f2;
            color: #dc2626;
        }

        .complexity-badge.expert {
            background: #f3e8ff;
            color: #7c3aed;
        }

        .option-features {
            margin: 12px 0;
        }

        .feature-tag {
            display: inline-block;
            background: #eff6ff;
            color: #2563eb;
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 11px;
            margin: 2px 4px 2px 0;
        }

        .spec-tag {
            display: block;
            color: #4b5563;
            font-size: 12px;
            margin: 2px 0;
        }

        .app-tag {
            display: inline-block;
            background: #f0fdf4;
            color: #16a34a;
            padding: 2px 6px;
            border-radius: 6px;
            font-size: 11px;
            margin: 2px 4px 2px 0;
        }

        .option-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #e2e8f0;
        }

        .time-estimate {
            color: #64748b;
            font-size: 12px;
        }

        .specs-section, .applications-section {
            margin: 12px 0;
        }

        .specs-section strong, .applications-section strong {
            display: block;
            color: var(--text-secondary);
            font-size: 13px;
            margin-bottom: 6px;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 14px;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: normal;
            color: var(--text-secondary);
            cursor: pointer;
            transition: color 0.3s;
        }

        .checkbox-group label:hover {
            color: var(--text-primary);
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            border: 2px solid var(--border-primary);
            border-radius: 4px;
            background: var(--bg-card);
            cursor: pointer;
            transition: all 0.3s;
        }

        .checkbox-group input[type="checkbox"]:checked {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
        }

        .form-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .form-section h3 {
            color: var(--text-primary);
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .feature-badge {
            background: var(--accent-primary);
            color: var(--text-primary);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .complexity-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .complexity-basic { background: var(--accent-success); color: var(--text-primary); }
        .complexity-intermediate { background: var(--accent-warning); color: var(--text-primary); }
        .complexity-advanced { background: var(--accent-error); color: var(--text-primary); }
        .complexity-expert { background: var(--accent-secondary); color: var(--text-primary); }

        .template-type-card {
            border: 1px solid var(--border-primary);
            border-radius: 16px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .template-type-card::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-primary);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .template-type-card:hover {
            border-color: var(--accent-primary);
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(59, 130, 246, 0.15);
            background: var(--bg-card);
        }

        .template-type-card:hover::before {
            opacity: 1;
        }

        .template-type-card.selected {
            border-color: var(--accent-primary);
            background: var(--bg-card);
        }

        .template-type-card.selected::before {
            opacity: 1;
        }

        .messages {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
            background: var(--bg-surface);
        }

        .messages::-webkit-scrollbar {
            width: 8px;
        }

        .messages::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: 4px;
        }

        .messages::-webkit-scrollbar-thumb {
            background: var(--border-primary);
            border-radius: 4px;
        }

        .message {
            margin-bottom: 20px;
        }

        .message.assistant {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 20px;
            box-shadow: var(--shadow-md);
        }

        .message.user {
            text-align: right;
        }

        .message.user .message-content {
            display: inline-block;
            background: var(--gradient-primary);
            color: var(--text-primary);
            padding: 14px 20px;
            border-radius: 16px;
            max-width: 70%;
            font-weight: 500;
        }

        .welcome-message {
            margin-bottom: 20px;
        }

        .creator-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 16px;
        }

        .creator-card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: center;
            user-select: none;
            position: relative;
            overflow: hidden;
        }

        .creator-card::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-primary);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .creator-card:hover {
            border-color: var(--accent-primary);
            background: var(--bg-card);
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(59, 130, 246, 0.15);
        }

        .creator-card:hover::before {
            opacity: 1;
        }

        .creator-card:active {
            transform: translateY(-2px);
        }

        .creator-card .icon {
            font-size: 32px;
            margin-bottom: 16px;
            padding: 16px;
            background: var(--gradient-primary);
            border-radius: 16px;
            color: white;
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.3);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .creator-card:hover .icon {
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 12px 30px rgba(59, 130, 246, 0.4);
        }

        .creator-card .title {
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--text-primary);
            font-size: 16px;
        }

        .creator-card .desc {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .cost-estimator-float {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 280px;
            background: var(--glass-bg);
            border: 1px solid var(--border-primary);
            border-radius: 20px;
            padding: 20px;
            backdrop-filter: blur(20px);
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: move;
        }
        
        .cost-estimator-float.editor-open {
            z-index: 500;
            opacity: 0.3;
            transform: scale(0.9);
            pointer-events: none;
        }

        .cost-estimator-float:hover {
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
        }

        .cost-estimator-float.dragging {
            cursor: grabbing;
            user-select: none;
        }

        .cost-estimator-header {
            cursor: grab;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-primary);
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(147, 51, 234, 0.1) 100%);
            margin: -20px -20px 16px -20px;
            padding: 16px 20px 12px 20px;
            border-radius: 20px 20px 0 0;
            position: relative;
        }

        .cost-estimator-header::before {
            content: '‚ãÆ‚ãÆ';
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            font-size: 14px;
            letter-spacing: 2px;
        }

        .cost-estimator-header:active {
            cursor: grabbing;
        }

        .sidebar {
            display: none; /* Hide original sidebar - only show floating cost estimator */
        }

        .sidebar-section {
            background: var(--bg-card);
            border: 1px solid var(--border-primary);
            border-radius: 16px;
            padding: 20px;
            box-shadow: var(--shadow-md);
            backdrop-filter: blur(10px);
        }

        .sidebar-title {
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-primary);
            font-size: 16px;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
        }

        .cost-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .cost-total {
            border-top: 1px solid var(--border-primary);
            padding-top: 12px;
            margin-top: 12px;
            font-weight: 700;
            font-size: 16px;
            color: var(--text-primary);
        }

        .session-info {
            font-size: 13px;
            color: var(--text-muted);
            line-height: 1.6;
        }

        .session-info strong {
            color: var(--text-secondary);
            font-weight: 600;
        }

        .pricing-guide {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .pricing-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-primary);
        }

        .pricing-item:last-child {
            border-bottom: none;
        }

        .pricing-item span:first-child {
            color: var(--text-secondary);
            font-size: 13px;
        }

        .pricing-item span:last-child {
            color: var(--text-primary);
            font-weight: 600;
            font-size: 14px;
        }

        /* Fix text readability issues */
        .status-indicator {
            width: 8px;
            height: 8px;
            background: var(--accent-success);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .session-status {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .session-status-text {
            color: var(--accent-success);
            font-weight: 600;
            font-size: 13px;
        }

        .session-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 13px;
        }

        .session-item .label {
            color: var(--text-muted);
        }

        .session-item .value {
            color: var(--text-primary);
            font-weight: 500;
        }

        /* Enhanced cost display */
        .cost-summary {
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .cost-display {
            text-align: center;
        }

        .cost-amount {
            font-size: 32px;
            font-weight: 800;
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 50%, #06b6d4 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            animation: glow 2s ease-in-out infinite alternate;
            margin-bottom: 4px;
        }

        @keyframes glow {
            from { filter: brightness(1); }
            to { filter: brightness(1.2); }
        }

        .selected-items {
            margin-top: 16px;
            border-top: 1px solid var(--border-primary);
            padding-top: 12px;
        }

        .selected-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            animation: fadeIn 0.3s ease-out;
        }

        .selected-item:last-child {
            border-bottom: none;
        }

        .item-info {
            flex: 1;
            min-width: 0;
        }

        .item-name {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-primary);
            display: block;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .item-price {
            font-size: 11px;
            color: var(--accent-primary);
            font-weight: 600;
        }

        .remove-item {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #ef4444;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
            margin-left: 8px;
        }

        .remove-item:hover {
            background: rgba(239, 68, 68, 0.2);
            transform: scale(1.1);
        }

        .item-controls {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .quantity-btn {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            color: #3b82f6;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 11px;
            font-weight: bold;
            transition: all 0.2s ease;
        }

        .quantity-btn:hover {
            background: rgba(59, 130, 246, 0.2);
            transform: scale(1.1);
        }

        .add-to-cart-btn {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 8px;
            width: 100%;
        }

        .add-to-cart-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
            to {
                opacity: 0;
                transform: translateY(-10px) scale(0.9);
            }
        }

        /* Enhanced Professional Graphics */
        .enhanced-card {
            position: relative;
            overflow: hidden;
        }

        .enhanced-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .enhanced-card:hover::before {
            left: 100%;
        }

        /* Professional Send Button Enhancement */
        .send-button {
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%) !important;
            border: none !important;
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4) !important;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
            border-radius: 50% !important;
            width: 48px !important;
            height: 48px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
        }

        .send-button:hover {
            transform: translateY(-2px) scale(1.1) rotate(15deg) !important;
            box-shadow: 0 12px 30px rgba(59, 130, 246, 0.6) !important;
        }

        .send-button svg {
            transition: transform 0.3s ease !important;
        }

        .send-button:hover svg {
            transform: translateX(2px) !important;
        }

        /* Micro-interactions and Loading Animations */
        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 16px;
            justify-content: center;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: var(--accent-primary);
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typing {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1.2); opacity: 1; }
        }

        .button-loading {
            position: relative;
            color: transparent !important;
        }

        .button-loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        .card-hover-effect {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card-hover-effect:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }

        .ripple-effect {
            position: relative;
            overflow: hidden;
        }

        .ripple-effect::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .ripple-effect:active::before {
            width: 300px;
            height: 300px;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .slide-in-left {
            animation: slideInLeft 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideInLeft {
            from { opacity: 0; transform: translateX(-30px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .pulse-glow {
            animation: pulseGlow 2s ease-in-out infinite;
        }

        @keyframes pulseGlow {
            0%, 100% { box-shadow: 0 0 10px rgba(59, 130, 246, 0.3); }
            50% { box-shadow: 0 0 20px rgba(59, 130, 246, 0.6); }
        }

        .scale-on-hover {
            transition: transform 0.2s ease-out;
        }

        .scale-on-hover:hover {
            transform: scale(1.05);
        }

        .input-focus-glow {
            position: relative;
        }

        .input-focus-glow::after {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, var(--accent-primary), var(--accent-secondary));
            border-radius: inherit;
            z-index: -1;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .input-focus-glow:focus::after {
            opacity: 0.3;
        }

        .cost-label {
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .cost-breakdown {
            margin-top: 16px;
        }

        .cost-breakdown-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            font-size: 13px;
        }

        .cost-breakdown-item .item-count {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }

        .cost-breakdown-item .item-price {
            color: var(--text-primary);
            font-weight: 600;
        }

        .pricing-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }

        .input-container {
            padding: 20px;
            border-top: 1px solid #e2e8f0;
            background: var(--bg-card);
            color: var(--text-primary);
        }

        .input-row {
            display: flex;
            gap: 12px;
        }

        #messageInput {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #cbd5e1;
            border-radius: 24px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
        }

        #messageInput:focus {
            border-color: #2563eb;
        }

        #sendButton {
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        #sendButton:hover:not(:disabled) {
            background: #1d4ed8;
        }

        #sendButton:disabled {
            background: #94a3b8;
            cursor: not-allowed;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #64748b;
            font-size: 14px;
        }

        .loading.show {
            display: block;
        }

        @media (max-width: 1024px) {
            body {
                grid-template-columns: 1fr;
                grid-template-rows: 1fr auto;
            }
            
            .sidebar {
                grid-row: 2;
                flex-direction: row;
                overflow-x: auto;
            }
            
            .sidebar-section {
                min-width: 250px;
            }
        }

        @media (max-width: 768px) {
            .creator-grid {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="header">
            <span class="header-icon">üèóÔ∏è</span>
            <h1>üèóÔ∏è CADalytics Creator Factory</h1>
            <div class="status">
                <div class="status-badge">AI Online</div>
                <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Theme">üåô</button>
            </div>
        </div>
        
        <div class="chat-container">
            <!-- Main Chat Page -->
            <div id="mainPage" class="page active">
                <div class="messages" id="messages">
                    <div class="message assistant">
                        <div class="welcome-message">
                            <strong>üëã Welcome to the CADalytics Creator Factory!</strong> I'm here to help you build exactly what you need for Civil 3D.
                            <br><br>
                            <em>What are you looking to create today?</em>
                        </div>
                        
                        <div class="creator-grid">
                            <div class="creator-card enhanced-card card-hover-effect ripple-effect" onclick="openPage('lispPage')">
                                <div class="icon">‚ö°</div>
                                <div class="title">LISP Creator</div>
                                <div class="desc">Intelligent automation & custom routines</div>
                            </div>
                            <div class="creator-card enhanced-card card-hover-effect ripple-effect" onclick="openPage('templatePage')">
                                <div class="icon">üìê</div>
                                <div class="title">Template Creator</div>
                                <div class="desc">Professional drawing standards & layouts</div>
                            </div>
                            <div class="creator-card enhanced-card card-hover-effect ripple-effect" onclick="openPage('subassemblyPage')">
                                <div class="icon">üõ£Ô∏è</div>
                                <div class="title">Subassembly Selector</div>
                                <div class="desc">Advanced corridor design components</div>
                            </div>
                            <div class="creator-card enhanced-card card-hover-effect ripple-effect" onclick="selectCreator('custom')">
                                <div class="icon">üéØ</div>
                                <div class="title">Custom Solutions</div>
                                <div class="desc">Tailored engineering solutions & consulting</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="loading" id="loading">
                    <div class="typing-indicator">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                    <div style="text-align: center; margin-top: 8px; color: var(--text-secondary);">
                        Processing your message...
                    </div>
                </div>
                
                <div class="input-container">
                    <div class="input-row">
                        <input type="text" id="messageInput" class="input-focus-glow" placeholder="Or type your request here..." />
                        <button id="sendButton" class="send-button" onclick="sendMessage()">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="22" y1="2" x2="11" y2="13"></line>
                                <polygon points="22,2 15,22 11,13 2,9"></polygon>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- LISP Creator Page -->
            <div id="lispPage" class="page">
                <div class="page-header">
                    <button class="back-button" onclick="goBack()">‚Üê Back</button>
                    <span class="header-icon">‚ö°</span>
                    <h1>LISP Creator</h1>
                </div>
                <div class="page-content">
                    <h2 style="margin-bottom: 16px;">Choose Your LISP Routines</h2>
                    <p style="color: #64748b; margin-bottom: 24px;">Select from our pre-built automation tools or request a custom solution</p>
                    
                    <div class="options-grid" id="lispOptions">
                        <!-- LISP options will be populated here -->
                    </div>
                    
                    <div class="custom-section">
                        <div class="option-icon">üéØ</div>
                        <h3>Custom LISP Request</h3>
                        <p style="color: #64748b; margin: 12px 0;">Need something specific? Describe your automation needs</p>
                        <input type="text" class="custom-input" id="customLispInput" placeholder="Describe your custom LISP requirement...">
                        <button class="custom-button" onclick="requestCustomLisp()">Request Custom LISP</button>
                    </div>
                    
                    <div class="selection-summary" id="lispSummary" style="display: none;">
                        <h3>Your LISP Selection</h3>
                        <div id="lispSelectionList"></div>
                        <button class="proceed-button" onclick="completeLispSelection()">Complete LISP Selection</button>
                    </div>
                </div>
            </div>

            <!-- Subassembly Selector Page -->
            <div id="subassemblyPage" class="page">
                <div class="page-header">
                    <button class="back-button" onclick="goBack()">‚Üê Back</button>
                    <span class="header-icon">üõ£Ô∏è</span>
                    <h1>Subassembly Selector</h1>
                </div>
                <div class="page-content">
                    <h2 style="margin-bottom: 16px; color: var(--text-primary);">Corridor Components</h2>
                    <p style="color: var(--text-secondary); margin-bottom: 24px;">Build your corridor with our library of subassemblies</p>
                    
                    <div class="options-grid" id="subassemblyOptions">
                        <!-- Subassembly options will be populated here -->
                    </div>
                    
                    <div class="custom-section">
                        <div class="option-icon">üîß</div>
                        <h3>Custom Subassembly</h3>
                        <p style="color: var(--text-secondary); margin: 12px 0;">Need a specialized corridor component?</p>
                        <input type="text" class="custom-input" id="customSubInput" placeholder="Describe your custom subassembly requirement...">
                        <button class="custom-button" onclick="requestCustomSubassembly()">Request Custom Subassembly</button>
                    </div>
                    
                    <div class="selection-summary" id="subassemblySummary" style="display: none;">
                        <h3>Your Corridor Design</h3>
                        <div id="subassemblySelectionList"></div>
                        <button class="proceed-button" onclick="completeSubassemblySelection()">Complete Corridor Design</button>
                    </div>
                </div>
            </div>

            <!-- Template Creator Page -->
            <div id="templatePage" class="page">
                <div class="page-header">
                    <button class="back-button" onclick="goBack()">‚Üê Back</button>
                    <span class="header-icon">üìê</span>
                    <h1>Template Creator</h1>
                </div>
                <div class="page-content" style="max-width: 100%; overflow-x: hidden; padding-right: 320px; box-sizing: border-box;">
                    <h2 style="margin-bottom: 16px; color: var(--text-primary);">Professional Drawing Templates</h2>
                    <p style="color: var(--text-secondary); margin-bottom: 24px;">Click any template to customize layers and add to your estimate</p>
                    
                    <!-- Template Type Selection -->
                    <div style="margin-bottom: 32px; width: 100%; max-width: 100%;">
                        <div id="templateTypes" style="width: 100%; max-width: 100%;">
                            <!-- Template types will be populated here -->
                        </div>
                    </div>

                    <!-- Configuration Panel -->
                    <div id="templateConfig" style="display: none; background: var(--bg-secondary); border: 1px solid var(--border-primary); border-radius: 12px; padding: 24px; margin-bottom: 24px;">
                        <h3 style="margin-bottom: 16px; color: var(--text-primary);">2. Configure Template</h3>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                            <div>
                                <h4 style="color: var(--text-primary); margin-bottom: 12px;">Drawing Setup</h4>
                                <div class="form-group">
                                    <label>Sheet Size:</label>
                                    <select class="custom-input" id="sheetSize">
                                        <option value="ANSI A (8.5x11)">ANSI A (8.5" x 11")</option>
                                        <option value="ANSI B (11x17)">ANSI B (11" x 17")</option>
                                        <option value="ANSI C (17x22)">ANSI C (17" x 22")</option>
                                        <option value="ANSI D (22x34)" selected>ANSI D (22" x 34")</option>
                                        <option value="ANSI E (34x44)">ANSI E (34" x 44")</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Scale:</label>
                                    <select class="custom-input" id="drawingScale">
                                        <option value="1=10">1" = 10'</option>
                                        <option value="1=20" selected>1" = 20'</option>
                                        <option value="1=30">1" = 30'</option>
                                        <option value="1=40">1" = 40'</option>
                                        <option value="1=50">1" = 50'</option>
                                        <option value="1=100">1" = 100'</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Units:</label>
                                    <select class="custom-input" id="units">
                                        <option value="feet" selected>Feet</option>
                                        <option value="meters">Meters</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div>
                                <h4 style="color: var(--text-primary); margin-bottom: 12px;">Standards Compliance</h4>
                                <div class="checkbox-group">
                                    <label><input type="checkbox" checked> CAD Standards</label>
                                    <label><input type="checkbox" checked> Layer Naming Convention</label>
                                    <label><input type="checkbox"> MUTCD Compliance</label>
                                    <label><input type="checkbox"> State DOT Standards</label>
                                    <label><input type="checkbox"> ADA Compliance</label>
                                </div>
                            </div>
                        </div>

                        <div style="margin-top: 24px;">
                            <h4 style="color: var(--text-primary); margin-bottom: 12px;">Layer Configuration</h4>
                            <div id="layerConfig">
                                <!-- Dynamic layer configuration based on template type -->
                            </div>
                        </div>

                        <div style="margin-top: 24px;">
                            <h4 style="color: var(--text-primary); margin-bottom: 12px;">Title Block Information</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                <input type="text" class="custom-input" placeholder="Company Name" id="companyName">
                                <input type="text" class="custom-input" placeholder="Project Name" id="projectName">
                                <input type="text" class="custom-input" placeholder="Engineer/Designer" id="designer">
                                <input type="text" class="custom-input" placeholder="Project Number" id="projectNumber">
                            </div>
                        </div>
                    </div>

                    <!-- Custom Template Section -->
                    <div class="custom-section">
                        <div class="option-icon">‚öôÔ∏è</div>
                        <h3>Custom Template Requirements</h3>
                        <p style="color: var(--text-secondary); margin: 12px 0;">Need a specialized template? Describe your requirements</p>
                        <textarea class="custom-input" rows="4" placeholder="Describe specific requirements, standards, or special elements needed..."></textarea>
                        <button class="custom-button" onclick="requestCustomTemplate()">Request Custom Template</button>
                    </div>

                    <!-- Template Summary -->
                    <div class="selection-summary" id="templateSummary" style="display: none;">
                        <h3>Template Configuration Summary</h3>
                        <div id="templateDetails"></div>
                        <button class="proceed-button" onclick="generateTemplate()">Generate Template</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Template Editor Overlay -->
    <div id="templateEditorOverlay" class="template-editor-overlay">
        <div class="template-editor">
            <div class="editor-header">
                <div>
                    <h2 id="editorTitle">Customize Template</h2>
                    <p id="editorSubtitle" style="color: var(--text-secondary); margin: 0;"></p>
                </div>
                <button class="editor-close" onclick="closeTemplateEditor()">√ó</button>
            </div>
            
            <div class="editor-content">
                <!-- Selection Tabs -->
                <div class="selection-tabs" style="margin-bottom: 20px;">
                    <button class="tab-button active" onclick="switchTab('layers')" id="layersTab">üóÇÔ∏è Select Layers</button>
                    <button class="tab-button" onclick="switchTab('styles')" id="stylesTab">üé® Select Styles</button>
                </div>
                
                <!-- Layer Selection Section -->
                <div id="layersSection" class="tab-content">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3 style="margin: 0; color: var(--text-primary);">Select Layers</h3>
                        <div style="display: flex; gap: 12px;">
                            <button onclick="selectAllLayers()" style="padding: 6px 12px; background: var(--accent-color); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">Select All</button>
                            <button onclick="deselectAllLayers()" style="padding: 6px 12px; background: var(--bg-secondary); color: var(--text-secondary); border: 1px solid var(--border-primary); border-radius: 6px; cursor: pointer; font-size: 12px;">Deselect All</button>
                        </div>
                    </div>
                    <div id="layerList" class="layer-list">
                        <!-- Layer items will be populated here -->
                    </div>
                </div>
                
                <!-- CAD Styles Section -->
                <div id="stylesSection" class="tab-content" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3 style="margin: 0; color: var(--text-primary);">Select CAD Styles</h3>
                        <div style="display: flex; gap: 12px;">
                            <button onclick="selectAllStyles()" style="padding: 6px 12px; background: var(--accent-color); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">Select All</button>
                            <button onclick="deselectAllStyles()" style="padding: 6px 12px; background: var(--bg-secondary); color: var(--text-secondary); border: 1px solid var(--border-primary); border-radius: 6px; cursor: pointer; font-size: 12px;">Deselect All</button>
                        </div>
                    </div>
                    <div id="stylesDisplay" class="layer-list">
                        <!-- CAD styles will be populated here with same format as layers -->
                    </div>
                </div>
                
                <div id="customLayerSection" style="margin-bottom: 20px;">
                    <h4 style="color: var(--text-primary); margin-bottom: 12px;">Add Custom Layer</h4>
                    <div style="display: flex; gap: 12px;">
                        <input type="text" id="customLayerInput" placeholder="Enter layer name (e.g., C-ROAD-CURB)" 
                               style="flex: 1; padding: 10px; border: 1px solid var(--border-primary); border-radius: 8px; background: var(--bg-card); color: var(--text-primary);">
                        <button onclick="addCustomLayer()" style="padding: 10px 20px; background: var(--accent-color); color: white; border: none; border-radius: 8px; cursor: pointer;">Add</button>
                    </div>
                </div>
            </div>
            
            <div class="editor-actions">
                <button class="editor-btn editor-btn-cancel" onclick="closeTemplateEditor()">Cancel</button>
                <button class="editor-btn editor-btn-add" onclick="addCustomizedTemplate()">Add to Estimate</button>
            </div>
        </div>
    </div>

    <!-- Floating Cost Estimator -->
    <div class="cost-estimator-float" id="costEstimator">
        <div class="cost-estimator-header">
            <div class="sidebar-title">üíé Cost Estimate</div>
        </div>
        <div class="cost-summary">
            <div class="cost-display">
                <div class="cost-amount" id="totalCost">$0.00</div>
                <div class="cost-label">Estimated Total</div>
            </div>
            <div class="selected-items" id="selectedItems">
                <!-- Selected items with remove buttons will appear here -->
            </div>
        </div>
        <div class="cost-breakdown" id="costBreakdown" style="display: none;">
            <div class="cost-breakdown-item" id="lispBreakdown" style="display: none;">
                <span>LISP Routines<span class="item-count" id="lispCount">0</span></span>
                <span class="item-price" id="lispCost">$0.00</span>
            </div>
            <div class="cost-breakdown-item" id="templateBreakdown" style="display: none;">
                <span>Templates<span class="item-count" id="templateCount">0</span></span>
                <span class="item-price" id="templateCost">$0.00</span>
            </div>
            <div class="cost-breakdown-item" id="subBreakdown" style="display: none;">
                <span>Subassemblies<span class="item-count" id="subCount">0</span></span>
                <span class="item-price" id="subCost">$0.00</span>
            </div>
            <div class="cost-breakdown-item" id="customBreakdown" style="display: none;">
                <span>Custom Solutions<span class="item-count" id="customCount">0</span></span>
                <span class="item-price" id="customCost">$0.00</span>
            </div>
        </div>
    </div>

    <script>
        const messagesContainer = document.getElementById('messages');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const loading = document.getElementById('loading');
        let sessionId = null;
        let currentIntent = 'custom';
        let selections = {
            lisp: 0,
            template: 0,
            subassembly: 0,
            custom: 0
        };
        let selectedItems = {
            lisp: [],
            subassembly: [],
            template: []
        };

        // Initialize session
        async function initSession() {
            try {
                const response = await fetch('/api/sessions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ uid: `user_${Date.now()}` })
                });
                const session = await response.json();
                sessionId = session.id;
                updateSessionDisplay();
            } catch (error) {
                console.error('Failed to initialize session:', error);
                sessionId = 'xc89glFsVjUe'; // Fallback
                updateSessionDisplay();
            }
        }

        // Update session display
        function updateSessionDisplay() {
            // Safe element updates with null checks
            const sessionDisplay = document.getElementById('sessionDisplay');
            if (sessionDisplay) {
                sessionDisplay.textContent = sessionId ? sessionId.slice(0, 12) + '...' : 'Loading...';
            }
            
            const intentDisplay = document.getElementById('intentDisplay');
            if (intentDisplay) {
                intentDisplay.textContent = currentIntent.charAt(0).toUpperCase() + currentIntent.slice(1);
            }
            
            // Calculate totals
            const totalSelections = selections.lisp + selections.template + selections.subassembly + selections.custom;
            const selectionsCount = document.getElementById('selectionsCount');
            if (selectionsCount) {
                selectionsCount.textContent = totalSelections;
            }
            
            // Calculate costs
            const costs = {
                lisp: selections.lisp * 5,
                template: selections.template * 30,
                subassembly: selections.subassembly * 20,
                custom: selections.custom * 10
            };
            
            const total = Object.values(costs).reduce((sum, cost) => sum + cost, 0);
            
            // Update main cost display
            const totalCostElement = document.getElementById('totalCost');
            if (totalCostElement) {
                totalCostElement.textContent = `$${total.toFixed(2)}`;
            }
            
            // Show/hide breakdown based on selections
            const breakdown = document.getElementById('costBreakdown');
            if (breakdown) {
                if (totalSelections > 0) {
                    breakdown.style.display = 'block';
                    
                    // Update breakdown items safely
                    const updateBreakdownItem = (type, count, cost) => {
                        const breakdownElement = document.getElementById(`${type}Breakdown`);
                        const countElement = document.getElementById(`${type}Count`);
                        const costElement = document.getElementById(`${type}Cost`);
                        
                        if (breakdownElement && countElement && costElement) {
                            if (count > 0) {
                                breakdownElement.style.display = 'flex';
                                countElement.textContent = count;
                                costElement.textContent = `$${cost.toFixed(2)}`;
                            } else {
                                breakdownElement.style.display = 'none';
                            }
                        }
                    };
                    
                    updateBreakdownItem('lisp', selections.lisp, costs.lisp);
                    updateBreakdownItem('template', selections.template, costs.template);
                    updateBreakdownItem('sub', selections.subassembly, costs.subassembly);
                    updateBreakdownItem('custom', selections.custom, costs.custom);
                } else {
                    breakdown.style.display = 'none';
                }
            }
        }

        // Page navigation
        function openPage(pageId) {
            console.log('Opening page:', pageId);
            
            // Add fade out animation to current page
            const currentPage = document.querySelector('.page.active');
            if (currentPage) {
                currentPage.style.opacity = '0';
                currentPage.style.transform = 'translateY(-20px)';
            }
            
            setTimeout(() => {
                // Hide all pages
                document.querySelectorAll('.page').forEach(page => {
                    page.classList.remove('active');
                    page.style.opacity = '';
                    page.style.transform = '';
                });
                
                // Show selected page with animation
                const newPage = document.getElementById(pageId);
                newPage.classList.add('active', 'fade-in');
                
                // Remove fade-in class after animation
                setTimeout(() => {
                    newPage.classList.remove('fade-in');
                }, 500);
                
                // Initialize page content
                if (pageId === 'lispPage') {
                    initLispPage();
                    currentIntent = 'lisp';
                } else if (pageId === 'subassemblyPage') {
                    initSubassemblyPage();
                    currentIntent = 'subassembly';
                } else if (pageId === 'templatePage') {
                    loadTemplateTypes();
                    currentIntent = 'template';
                }
                
                updateSessionDisplay();
            }, 150);
        }

        function goBack() {
            // Add fade out animation
            const currentPage = document.querySelector('.page.active');
            if (currentPage) {
                currentPage.style.opacity = '0';
                currentPage.style.transform = 'translateY(-20px)';
            }
            
            setTimeout(() => {
                // Show main page
                document.querySelectorAll('.page').forEach(page => {
                    page.classList.remove('active');
                    page.style.opacity = '';
                    page.style.transform = '';
                });
                const mainPage = document.getElementById('mainPage');
                mainPage.classList.add('active', 'slide-in-left');
                
                setTimeout(() => {
                    mainPage.classList.remove('slide-in-left');
                }, 600);
                
                currentIntent = 'custom';
                updateSessionDisplay();
            }, 150);
        }

        // Select creator (for custom only now)
        async function selectCreator(type) {
            console.log('Creator selected:', type);
            
            currentIntent = type;
            updateSessionDisplay();
            
            if (type === 'custom') {
                addMessage('assistant', "I understand you have custom requirements. Let me help you create a specialized solution for your needs.");
            }
            
            // Send to AI for processing
            try {
                await sendToAI(`I want to use the ${type} creator`);
            } catch (error) {
                console.log('AI processing optional, continuing with local response');
            }
        }

        // Initialize LISP page
        function initLispPage() {
            const lispCategories = {
                "Layer & Drawing Management": [
                    { name: "Quick Layer Creator (QLC)", desc: "Instantly create and set current layer with NCS naming - Eliminates 8 clicks into 1 command", features: ["NCS naming", "One-click creation", "Auto-activation"], complexity: "Beginner", time: "Ready to use", price: "$25" },
                    { name: "Layer Isolator Pro (LIP)", desc: "Pick object to isolate its layer - One-click layer isolation without typing layer names", features: ["Object picking", "Instant isolation", "No typing"], complexity: "Beginner", time: "Ready to use", price: "$25" },
                    { name: "Layer State Cycler (LSC)", desc: "Cycle through predefined layer states - One-key switching for different design phases", features: ["Phase switching", "Predefined states", "One-key operation"], complexity: "Intermediate", time: "Ready to use", price: "$35" },
                    { name: "NCS Layer Fixer (NLF)", desc: "Fix common layer naming to NCS standards - Automated layer name compliance", features: ["NCS compliance", "Auto-fixing", "Batch processing"], complexity: "Intermediate", time: "Ready to use", price: "$30" }
                ],
                "Civil 3D Surface & Surveying": [
                    { name: "Surface Point Bomber (SPB)", desc: "Click anywhere to add elevation point to active surface - Instantly add survey points without opening surface dialog", features: ["Click placement", "No dialogs", "Active surface"], complexity: "Beginner", time: "Ready to use", price: "$35" },
                    { name: "Text Elevation Grabber (TEG)", desc: "Extract Z-coordinate and create text - Instantly labels elevations from 3D points", features: ["Z-coordinate extraction", "Auto-text creation", "3D point support"], complexity: "Beginner", time: "Ready to use", price: "$30" },
                    { name: "Surface Boundary Creator (SBC)", desc: "Convert selected polyline to surface boundary - One-click surface boundary creation", features: ["Polyline conversion", "One-click operation", "Boundary automation"], complexity: "Beginner", time: "Ready to use", price: "$30" }
                ],
                "Civil Infrastructure": [
                    { name: "Pipe Network Express (PNX)", desc: "Rapid pipe and structure placement in one command vs multiple dialogs", features: ["Pipe + structure", "Single command", "No dialogs"], complexity: "Intermediate", time: "Ready to use", price: "$45" },
                    { name: "Alignment Station Finder (ASF)", desc: "Click point to get station on nearest alignment - Instant station/offset calculations", features: ["Point clicking", "Station/offset", "Nearest alignment"], complexity: "Intermediate", time: "Ready to use", price: "$45" },
                    { name: "Profile Grade Calculator (PGC)", desc: "Calculate grade between two profile points - Instant grade calculations without manual math", features: ["Two-point grade", "Instant calculation", "No manual math"], complexity: "Intermediate", time: "Ready to use", price: "$40" },
                    { name: "Pipe Slope Validator (PSV)", desc: "Check if selected pipe meets minimum slope - Instant validation without opening properties", features: ["Slope validation", "Minimum standards", "No properties panel"], complexity: "Intermediate", time: "Ready to use", price: "$35" }
                ],
                "Text & Annotation": [
                    { name: "Batch Block Attribute Editor (BBAE)", desc: "Edit all selected block attributes at once - Update hundreds of blocks instantly vs one-by-one editing", features: ["Batch editing", "Mass updates", "Time saving"], complexity: "Advanced", time: "Ready to use", price: "$55" },
                    { name: "Contour Label Bomber (CLB)", desc: "Click contour to auto-label elevation - Instantly label contour elevations without manual typing", features: ["Contour clicking", "Auto-labeling", "No typing"], complexity: "Intermediate", time: "Ready to use", price: "$40" },
                    { name: "Quick Dimension Matcher (QDM)", desc: "Match dimension style of selected dimension across multiple dimensions instantly", features: ["Style matching", "Multiple selection", "Instant application"], complexity: "Intermediate", time: "Ready to use", price: "$25" }
                ],
                "Analysis & Measurement": [
                    { name: "Polyline Area Reporter (PAR)", desc: "Get area and perimeter of selected polyline instantly without Properties panel", features: ["Instant calculation", "Area & perimeter", "No properties"], complexity: "Beginner", time: "Ready to use", price: "$30" }
                ]
            };

            let optionsHtml = '';
            Object.entries(lispCategories).forEach(([category, options]) => {
                optionsHtml += `
                    <div style="margin-bottom: 32px;">
                        <h3 style="color: #1e293b; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 2px solid #e2e8f0;">${category}</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 16px;">
                            ${options.map(lisp => `
                                <div class="option-card detailed-card">
                                    <div class="option-header">
                                        <div class="option-icon">‚ö°</div>
                                        <div class="complexity-badge ${lisp.complexity.toLowerCase()}">${lisp.complexity}</div>
                                    </div>
                                    <div class="option-title">${lisp.name}</div>
                                    <div class="option-desc">${lisp.desc}</div>
                                    <div class="option-features">
                                        ${lisp.features.map(feature => `<span class="feature-tag">‚úì ${feature}</span>`).join('')}
                                    </div>
                                    <div class="option-footer">
                                        <div class="time-estimate">‚è±Ô∏è ${lisp.time}</div>
                                        <div class="option-price">${lisp.price}</div>
                                        <button class="add-to-cart-btn" onclick="addLispTool('${lisp.name}', ${lisp.price.replace('$', '')}, this)" title="Add to estimate">
                                            + Add to Estimate
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });

            document.getElementById('lispOptions').innerHTML = optionsHtml;
        }

        // Initialize Subassembly page
        function initSubassemblyPage() {
            const subassemblyCategories = {
                "Standard Curb Types": [
                    { name: "Type A Curb", desc: "Standard barrier curb for use adjacent to concrete or flexible pavement", specs: ["7\" vertical face", "Rounded top", "3/4\" radius corners"], applications: ["Roadways", "Parking lots", "General purpose"], price: "$25" },
                    { name: "Type B Curb", desc: "Sloped/mountable curb with transition from full height to zero in 3 feet", specs: ["Gradual slope", "Emergency access", "Flared end options"], applications: ["Emergency vehicle areas", "Occasional crossing zones"], price: "$22" },
                    { name: "Type D Curb", desc: "Low profile barrier curb with reduced visual obstruction", specs: ["4-6\" face height", "Type A profile", "3 foot transitions"], applications: ["Areas requiring less obstruction", "Traffic control"], price: "$20" },
                    { name: "Drop Curb", desc: "Low-profile curb allowing smooth vehicle transition", specs: ["2-3\" above gutter", "Smooth transition", "ADA compliant"], applications: ["Driveway connections", "ADA ramps", "Pedestrian crossings"], price: "$18" }
                ],
                "Curb & Gutter Systems": [
                    { name: "Type E Curb and Gutter", desc: "Integral curb and gutter system with 6\" minimum lip thickness", specs: ["7\" curb face", "2'-0\" gutter width", "Cross slope matching"], applications: ["Standard roadways", "Stormwater collection"], price: "$35" },
                    { name: "Type F Curb and Gutter", desc: "Heavy-duty integral curb and gutter for traffic-bearing applications", specs: ["Reinforced design", "6\" lip thickness", "Traffic loading"], applications: ["Roundabout central islands", "Vehicle traverse areas"], price: "$42" },
                    { name: "Type RA Roundabout Curb", desc: "Special curved curb designed for roundabout applications", specs: ["Rotates with pavement slope", "Curved geometry", "Optimized drainage"], applications: ["Central islands", "Splitter islands", "Roundabouts"], price: "$45" },
                    { name: "Valley Gutter", desc: "Depressed gutter section for concentrated drainage", specs: ["V-shaped cross-section", "Enhanced capacity", "Stormwater conveyance"], applications: ["Sag curves", "Drainage collection points"], price: "$28" }
                ],
                "Specialized Elements": [
                    { name: "Shoulder Gutter", desc: "Standalone gutter section without integral curb", specs: ["1'-6\" to 2'-0\" wide", "No vertical barrier", "Highway standard"], applications: ["Highway shoulders", "Areas without curb barrier"], price: "$15" },
                    { name: "Concrete Bumper Guard", desc: "Protective barrier for parking applications", specs: ["6\" typical height", "Anchor bolts", "#4 reinforcing bars"], applications: ["Parking lots", "Loading areas", "Building protection"], price: "$22" },
                    { name: "Toll Header Curb", desc: "Specialized curb for toll plaza applications", specs: ["Equipment provisions", "Utility conduits", "Equipment mounting"], applications: ["Electronic toll collection", "Toll plazas"], price: "$38" },
                    { name: "Asphaltic Concrete Curb", desc: "Temporary or low-cost curb alternative using hot mix asphalt", specs: ["HMA material", "Flexible design", "Less durable"], applications: ["Temporary installations", "Low-traffic areas"], price: "$12" }
                ],
                "Drainage Systems": [
                    { name: "V-Ditch Rural", desc: "Trapezoidal drainage ditch for rural applications", specs: ["3:1 side slopes", "Variable depth", "Grass lined"], applications: ["Rural roads", "Highways"], price: "$15" },
                    { name: "Box Culvert", desc: "Reinforced concrete box culvert for drainage", specs: ["Reinforced concrete", "Custom sizing", "Headwalls included"], applications: ["Stream crossings", "Large flow"], price: "$45" },
                    { name: "Swale Bio-retention", desc: "Engineered bioswale for stormwater management", specs: ["Engineered soil", "Native plants", "Overflow structure"], applications: ["Green infrastructure", "Urban areas"], price: "$35" }
                ],
                "Pedestrian Infrastructure": [
                    { name: "ADA Compliant Sidewalk", desc: "5-foot concrete sidewalk meeting ADA requirements", specs: ["5' width minimum", "2% max cross slope", "ADA compliant"], applications: ["Urban areas", "Transit stops"], price: "$20" },
                    { name: "Multi-Use Path", desc: "12-foot asphalt path for bikes and pedestrians", specs: ["12' width", "Asphalt surface", "Striped"], applications: ["Parks", "Trails"], price: "$30" },
                    { name: "Bike Lane Separated", desc: "Protected bike lane with physical barrier", specs: ["6' lane width", "Physical barrier", "Striping"], applications: ["Urban streets", "Bike networks"], price: "$25" }
                ],
                "Barriers & Walls": [
                    { name: "Guardrail W-Beam", desc: "Standard W-beam guardrail system", specs: ["W-beam rail", "Steel posts", "Reflectors"], applications: ["Highways", "Bridge approaches"], price: "$32" },
                    { name: "Sound Wall Concrete", desc: "Precast concrete sound barrier wall", specs: ["Precast panels", "Custom height", "Aesthetic options"], applications: ["Residential areas", "Highways"], price: "$65" },
                    { name: "Retaining Wall MSE", desc: "Mechanically stabilized earth retaining wall", specs: ["Modular blocks", "Geogrid reinforcement", "Tiered design"], applications: ["Cut/fill transitions", "Bridge approaches"], price: "$55" },
                    { name: "Jersey Barrier", desc: "Portable concrete traffic barrier", specs: ["Standard profile", "Interlocking", "Reflective tape"], applications: ["Work zones", "Temporary barriers"], price: "$28" }
                ],
                "Specialized Elements": [
                    { name: "Median Island", desc: "Raised concrete median with landscaping", specs: ["Variable width", "Drainage", "Landscape ready"], applications: ["Intersections", "Boulevard"], price: "$40" },
                    { name: "Bus Stop Pad", desc: "Concrete boarding area for transit stops", specs: ["ADA compliant", "Non-slip surface", "Integrated drainage"], applications: ["Bus routes", "Transit centers"], price: "$35" },
                    { name: "Truck Apron", desc: "Reinforced concrete apron for truck turning", specs: ["Heavy duty concrete", "Reinforced", "Scored surface"], applications: ["Intersections", "Industrial"], price: "$42" }
                ]
            };

            let optionsHtml = '';
            Object.entries(subassemblyCategories).forEach(([category, options]) => {
                optionsHtml += `
                    <div style="margin-bottom: 32px;">
                        <h3 style="color: #1e293b; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 2px solid #e2e8f0;">${category}</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 16px;">
                            ${options.map(sub => `
                                <div class="option-card detailed-card">
                                    <div class="option-header">
                                        <div class="option-icon">üèóÔ∏è</div>
                                        <div class="option-price">${sub.price}</div>
                                    </div>
                                    <div class="option-title">${sub.name}</div>
                                    <div class="option-desc">${sub.desc}</div>
                                    <div class="specs-section">
                                        <strong>Specifications:</strong>
                                        ${sub.specs.map(spec => `<span class="spec-tag">‚Ä¢ ${spec}</span>`).join('')}
                                    </div>
                                    <div class="applications-section">
                                        <strong>Applications:</strong>
                                        ${sub.applications.map(app => `<span class="app-tag">${app}</span>`).join('')}
                                    </div>
                                    <div class="option-footer">
                                        <button class="add-to-cart-btn" onclick="addSubassemblyTool('${sub.name}', ${sub.price.replace('$', '')}, this)" title="Add to estimate">
                                            + Add to Estimate
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });

            document.getElementById('subassemblyOptions').innerHTML = optionsHtml;
        }

        // Load template types when the page loads
        function loadTemplateTypes() {
            const templateTypes = [
                { 
                    name: "Site Plan", 
                    icon: "üèóÔ∏è", 
                    desc: "Comprehensive site development plans with utilities, grading, and landscaping",
                    layers: ["Existing Conditions", "Proposed Buildings", "Utilities", "Grading", "Landscaping", "Parking"],
                    price: "$45"
                },
                { 
                    name: "Road Design", 
                    icon: "üõ£Ô∏è", 
                    desc: "Highway and street design with alignments, profiles, and cross-sections",
                    layers: ["Centerline", "ROW", "Pavement", "Shoulders", "Drainage", "Utilities", "Traffic Control"],
                    price: "$55"
                },
                { 
                    name: "Survey Plan", 
                    icon: "üìê", 
                    desc: "Boundary surveys, topographic surveys, and ALTA/NSPS land title surveys",
                    layers: ["Boundary", "Topography", "Structures", "Utilities", "Easements", "Annotations"],
                    price: "$35"
                },
                { 
                    name: "Subdivision", 
                    icon: "üèòÔ∏è", 
                    desc: "Residential and commercial subdivision layouts with lots and infrastructure",
                    layers: ["Lots", "Streets", "Utilities", "Drainage", "Open Space", "Phasing"],
                    price: "$50"
                },
                { 
                    name: "Utility Plan", 
                    icon: "‚ö°", 
                    desc: "Water, sewer, storm, electric, and telecommunications utility design",
                    layers: ["Water", "Sewer", "Storm", "Electric", "Communications", "Conflicts"],
                    price: "$40"
                },
                { 
                    name: "Construction", 
                    icon: "üîß", 
                    desc: "Construction documents with details, specifications, and sequencing",
                    layers: ["Demolition", "Construction", "Details", "Sections", "Notes", "Sequencing"],
                    price: "$42"
                }
            ];

            // Comprehensive AIA-compliant templates with full CAD styles
            const templates = {
                "Essential Templates": [
                    {
                        name: "Minimal Template",
                        icon: "üìù",
                        desc: "Basic styles and Layer 0 only - simplest starting point",
                        features: ["Standard text styles", "Basic dimension styles", "Layer 0 setup", "Minimal plotting setup"],
                        layers: ["0 (Default layer)"],
                        styles: {
                            text: ["STANDARD (0.125\" height)", "TITLE (0.25\" height)"],
                            dimension: ["STANDARD (0.09\" text, 0.0625\" arrows)", "ARCHITECTURAL (0.125\" text)"],
                            surface: ["STANDARD (2' major, 1' minor contours)", "EXISTING (dashed contours)"],
                            mleader: ["STANDARD (arrow, 0.09\" text)", "NOTE (dot, 0.08\" text)"],
                            plot: ["ANSI A (8.5x11)", "ANSI D (22x34)"]
                        },
                        price: "$25"
                    },
                    {
                        name: "Master Template", 
                        icon: "üè¢",
                        desc: "Comprehensive template with all AIA standard layers and styles",
                        features: ["All AIA standard layers", "Complete text/dimension styles", "Standard line weights", "Professional plotting setup"],
                        layers: ["All discipline layers (A-, C-, S-, M-, E-, P-, F-, L-)", "Complete annotation layers", "All standard layer combinations"],
                        styles: {
                            text: [
                                "STANDARD (0.125\", Arial)", "ANNOTATIVE (Annotative, Arial)", 
                                "DECIMAL-2 (0.09\", 2 decimal places)", "ARIAL (0.125\", Arial font)", 
                                "SIMPLEX (0.125\", Simplex font)", "LARGE (0.1875\", Arial Bold)", 
                                "SMALL (0.09\", Arial)", "TITLE (0.25\", Arial Bold)", 
                                "SUBTITLE (0.1875\", Arial)", "NOTE (0.08\", Simplex)", 
                                "LABEL (0.0625\", Arial)", "SPOT-ELEV-DOT (0.08\" with dot)",
                                "SPOT-ELEV-LEADER (0.08\" with leader)", "COORDINATES (X,Y,Z format)"
                            ],
                            dimension: [
                                "ARCHITECTURAL (0.125\" Arial)", "CIVIL (0.09\" Arial, 2 decimal)", 
                                "STRUCTURAL (0.1\" Arial)", "MEP (0.08\" Arial)", 
                                "SURVEY (0.0625\" Arial)", "ANNOTATIVE-DIM (Annotative scaling)",
                                "ELEVATION-DIM (spot elevations)", "COORDINATE-DIM (X,Y coordinates)"
                            ],
                            surface: [
                                "EXISTING (dashed, brown)", "PROPOSED (solid, red)", 
                                "DESIGN (solid, green)", "SPOT-ELEV-POINTS (elevation markers)", 
                                "CONTOUR-MAJOR (2' intervals)", "CONTOUR-MINOR (1' intervals)",
                                "ELEVATION-MARKERS (with text)"
                            ],
                            mleader: [
                                "STANDARD (arrow)", "SPOT-ELEV-DOT (dot, elevation text)", 
                                "SPOT-ELEV-LEADER (arrow, elevation)", "BUBBLE (circle)", 
                                "NOTE (dot)", "DETAIL (triangle)", "SECTION (flag)", 
                                "ELEVATION (square)", "COORDINATE-LEADER (X,Y,Z)"
                            ],
                            plot: ["ANSI A-E (all sizes)", "ARCH A-E (all sizes)", "ISO A0-A4", "Custom sizes"],
                            lineweight: ["0.13mm (fine)", "0.25mm (medium)", "0.35mm (thick)", "0.50mm (extra thick)", "0.70mm (borders)"],
                            linetype: ["CONTINUOUS", "DASHED", "CENTER", "HIDDEN", "PHANTOM", "PROPERTY", "UTILITY"]
                        },
                        price: "$125"
                    }
                ],
                "Project-Specific Templates": [
                    {
                        name: "Site Plan Template",
                        icon: "üó∫Ô∏è", 
                        desc: "Site planning layers for property boundaries, topography, and site features",
                        features: ["Property boundary layers", "Topographic elements", "Site features", "Landscape elements"],
                        layers: ["C-PROP (Property lines)", "C-TOPO (Topography)", "C-ROAD (Roads)", "L-PLNT (Planting)", "C-BLDG (Buildings)", "A-SITE (Site elements)"],
                        price: "$45"
                    },
                    {
                        name: "Existing Conditions Template",
                        icon: "üìã",
                        desc: "Survey and existing conditions with comprehensive documentation layers", 
                        features: ["Survey control points", "Existing utilities", "As-built documentation", "Field verification layers"],
                        layers: ["V-NTWK (Survey network)", "V-TOPO-E (Existing topography)", "C-UTIL-WATR-E (Existing water)", "C-UTIL-SEWR-E (Existing sewer)", "C-UTIL-ELEC-E (Existing electrical)", "V-PROP-BRNG (Property bearings)"],
                        price: "$55"
                    },
                    {
                        name: "Proposed Surface Template", 
                        icon: "üèóÔ∏è",
                        desc: "Everything needed for proposed surface design and grading",
                        features: ["Proposed grading", "Surface modeling", "Cut/fill analysis", "Earthwork calculations"],
                        layers: ["C-TOPO-N (Proposed contours)", "C-GRAD-N (Proposed grading)", "C-ROAD-PAVE-N (Proposed pavement)", "C-UTIL-STOM-N (Storm drainage)", "C-SITE-FEAT-N (Site features)"],
                        price: "$65"
                    }
                ],
                "Infrastructure Templates": [
                    {
                        name: "Drainage Template",
                        icon: "üåä",
                        desc: "Complete drainage design with storm systems and hydrology",
                        features: ["Storm drain systems", "Catch basins & inlets", "Retention/detention", "Hydrology calculations"],
                        layers: ["C-UTIL-STOM (Storm drainage)", "C-UTIL-STOM-PIPE (Storm pipes)", "C-UTIL-STOM-STRH (Storm structures)", "C-WATR (Water features)", "C-UTIL-STOM-LABL (Drainage labels)"],
                        price: "$75"
                    },
                    {
                        name: "Utilities Template",
                        icon: "‚ö°",
                        desc: "All utility systems - water, sewer, electrical, gas, telecom",
                        features: ["Water distribution", "Sewer collection", "Electrical systems", "Gas & telecom"],
                        layers: ["C-UTIL-WATR (Water)", "C-UTIL-SEWR (Sewer)", "E-POWR (Electrical power)", "C-UTIL-GAS (Gas)", "T-COMM (Telecommunications)", "C-UTIL-FIRE (Fire protection)"],
                        price: "$85"
                    }
                ],
                "Presentation Templates": [
                    {
                        name: "Plot Sheet Template",
                        icon: "üìÑ", 
                        desc: "Professional title blocks, borders, and presentation setup",
                        features: ["Standard title blocks", "Sheet borders", "Professional stamps", "Revision tracking"],
                        layers: ["G-ANNO-TTLB (Title block)", "G-ANNO-REVS (Revisions)", "G-ANNO-STMP (Professional stamp)", "G-ANNO-LOGO (Company logo)", "G-ANNO-NOTE (General notes)"],
                        price: "$35"
                    }
                ]
            };

            // Auto-populate comprehensive CAD styles for all templates
            populateTemplateStyles(templates);

            let templatesHtml = `
                <style>
                .template-card {
                    background: var(--bg-card);
                    border: 1px solid var(--border-primary);
                    border-radius: 16px;
                    padding: 24px;
                    transition: all 0.3s ease;
                    height: 100%;
                    display: flex;
                    flex-direction: column;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
                }
                .template-card:hover {
                    border-color: var(--accent-color);
                    transform: translateY(-4px);
                    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
                }
                .template-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: flex-start;
                    margin-bottom: 16px;
                }
                .template-icon {
                    font-size: 40px;
                    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
                }
                .template-price {
                    font-size: 18px;
                    font-weight: 700;
                    color: var(--accent-color);
                    background: var(--accent-light);
                    padding: 6px 12px;
                    border-radius: 8px;
                    border: 1px solid var(--accent-color);
                }
                .template-title {
                    font-size: 20px;
                    font-weight: 700;
                    color: var(--text-primary);
                    margin: 0 0 12px 0;
                    line-height: 1.2;
                }
                .template-desc {
                    color: var(--text-secondary);
                    font-size: 15px;
                    margin-bottom: 20px;
                    line-height: 1.5;
                    flex-grow: 1;
                }
                .template-section {
                    margin-bottom: 16px;
                }
                .template-section-title {
                    color: var(--text-primary);
                    font-size: 14px;
                    font-weight: 600;
                    display: block;
                    margin-bottom: 10px;
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                }
                .feature-tag {
                    display: inline-block;
                    background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
                    color: var(--text-secondary);
                    padding: 6px 10px;
                    border-radius: 8px;
                    font-size: 12px;
                    margin: 3px 6px 3px 0;
                    border: 1px solid var(--border-primary);
                    font-weight: 500;
                }
                .layer-code {
                    background: var(--bg-tertiary);
                    color: var(--text-primary);
                    padding: 4px 8px;
                    border-radius: 6px;
                    font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
                    font-size: 11px;
                    border: 1px solid var(--border-secondary);
                    margin: 2px 4px 2px 0;
                    display: inline-block;
                    font-weight: 500;
                }
                .template-footer {
                    margin-top: auto;
                    padding-top: 16px;
                    border-top: 1px solid var(--border-primary);
                }
                .template-category {
                    margin-bottom: 40px;
                }
                .template-category-title {
                    color: var(--text-primary);
                    font-size: 24px;
                    font-weight: 700;
                    margin-bottom: 20px;
                    padding-bottom: 12px;
                    border-bottom: 3px solid var(--accent-color);
                    position: relative;
                }
                .template-category-title::after {
                    content: '';
                    position: absolute;
                    bottom: -3px;
                    left: 0;
                    width: 60px;
                    height: 3px;
                    background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
                    border-radius: 2px;
                }
                .template-grid {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
                    gap: 20px;
                    max-width: 100%;
                    margin: 0 auto;
                }
                
                /* Responsive grid adjustments */
                @media (max-width: 1400px) {
                    .template-grid {
                        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
                        gap: 16px;
                    }
                    .page-content {
                        padding-right: 300px !important;
                    }
                }
                
                @media (max-width: 1200px) {
                    .template-grid {
                        grid-template-columns: repeat(2, 1fr);
                        gap: 16px;
                    }
                    .page-content {
                        padding-right: 20px !important;
                    }
                    .cost-estimator-float {
                        display: none !important;
                    }
                }
                
                @media (max-width: 900px) {
                    .template-grid {
                        grid-template-columns: 1fr;
                        gap: 16px;
                    }
                }
                
                /* Prevent cards from overflowing */
                .template-card {
                    max-width: 100%;
                    box-sizing: border-box;
                    overflow: hidden;
                }
                
                .styles-grid {
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 8px;
                    margin-top: 8px;
                }
                
                .style-category {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 4px 8px;
                    background: var(--bg-tertiary);
                    border-radius: 6px;
                    border: 1px solid var(--border-secondary);
                }
                
                .style-label {
                    font-size: 11px;
                    font-weight: 600;
                    color: var(--text-primary);
                }
                
                .style-count {
                    font-size: 10px;
                    color: var(--accent-color);
                    font-weight: 500;
                    background: var(--accent-light);
                    padding: 2px 6px;
                    border-radius: 4px;
                }
                
                .styles-display {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                    gap: 16px;
                    margin-bottom: 20px;
                }
                
                .style-category-block {
                    background: var(--bg-secondary);
                    border: 1px solid var(--border-primary);
                    border-radius: 12px;
                    padding: 16px;
                }
                
                .style-category-header {
                    color: var(--text-primary);
                    font-size: 14px;
                    font-weight: 600;
                    margin: 0 0 12px 0;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                }
                
                .style-category-header::before {
                    content: 'üé®';
                    font-size: 16px;
                }
                
                .style-items {
                    display: flex;
                    flex-wrap: wrap;
                    gap: 6px;
                }
                
                .style-item {
                    background: var(--bg-tertiary);
                    color: var(--text-secondary);
                    padding: 4px 8px;
                    border-radius: 6px;
                    font-size: 11px;
                    font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
                    border: 1px solid var(--border-secondary);
                    white-space: nowrap;
                    cursor: pointer;
                    transition: all 0.3s ease;
                }
                
                .style-item:hover {
                    border-color: var(--accent-color);
                    background: var(--accent-light);
                }
                
                .style-item.selected {
                    background: var(--accent-color);
                    color: white;
                    border-color: var(--accent-color);
                }
                
                .selection-tabs {
                    display: flex;
                    gap: 4px;
                    background: var(--bg-secondary);
                    padding: 4px;
                    border-radius: 12px;
                    border: 1px solid var(--border-primary);
                }
                
                .tab-button {
                    flex: 1;
                    padding: 10px 16px;
                    border: none;
                    background: transparent;
                    color: var(--text-secondary);
                    border-radius: 8px;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    font-weight: 500;
                    font-size: 14px;
                }
                
                .tab-button.active {
                    background: var(--accent-color);
                    color: white;
                    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);
                }
                
                .tab-button:hover:not(.active) {
                    background: var(--bg-tertiary);
                    color: var(--text-primary);
                }
                
                .tab-content {
                    animation: fadeIn 0.3s ease;
                }
                
                @keyframes fadeIn {
                    from { opacity: 0; transform: translateY(10px); }
                    to { opacity: 1; transform: translateY(0); }
                }
                .template-card {
                    cursor: pointer;
                    position: relative;
                }
                .template-card::before {
                    content: 'Click to customize';
                    position: absolute;
                    top: 10px;
                    right: 10px;
                    background: rgba(59, 130, 246, 0.1);
                    color: var(--accent-color);
                    padding: 4px 8px;
                    border-radius: 6px;
                    font-size: 11px;
                    opacity: 0;
                    transition: opacity 0.3s;
                    pointer-events: none;
                }
                .template-card:hover::before {
                    opacity: 1;
                }
                .template-customize-btn {
                    width: 100%;
                    background: linear-gradient(135deg, var(--accent-color), var(--primary-color));
                    color: white;
                    border: none;
                    padding: 12px 16px;
                    border-radius: 10px;
                    font-weight: 600;
                    font-size: 14px;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                }
                .template-customize-btn:hover {
                    transform: translateY(-2px);
                    box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
                }
                .layer-more {
                    color: var(--text-secondary);
                    font-size: 11px;
                    margin-left: 8px;
                    font-style: italic;
                }
                .template-editor-overlay {
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0, 0, 0, 0.6);
                    backdrop-filter: blur(12px);
                    z-index: 15000;
                    display: none;
                    align-items: center;
                    justify-content: center;
                    padding: 20px;
                }
                .template-editor {
                    background: var(--bg-card);
                    border-radius: 20px;
                    padding: 30px;
                    max-width: 900px;
                    width: 100%;
                    max-height: 85vh;
                    overflow-y: auto;
                    box-shadow: 0 25px 80px rgba(0, 0, 0, 0.4);
                    border: 2px solid var(--border-primary);
                    position: relative;
                    margin-left: auto;
                    margin-right: auto;
                    transform: translateY(0);
                }
                
                /* Ensure editor doesn't overlap with cost estimator */
                @media (min-width: 1200px) {
                    .template-editor {
                        margin-right: 320px; /* Leave space for cost estimator */
                        max-width: calc(100vw - 400px);
                    }
                }
                
                /* On smaller screens, temporarily hide cost estimator when editor is open */
                .template-editor-overlay.active ~ .cost-estimator-float {
                    display: none;
                }
                
                .template-editor-overlay.active {
                    display: flex;
                }
                .editor-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 24px;
                    padding-bottom: 16px;
                    border-bottom: 2px solid var(--border-primary);
                }
                .editor-close {
                    background: none;
                    border: none;
                    font-size: 24px;
                    cursor: pointer;
                    color: var(--text-secondary);
                    padding: 8px;
                    border-radius: 8px;
                    transition: all 0.3s;
                }
                .editor-close:hover {
                    background: var(--bg-secondary);
                    color: var(--text-primary);
                }
                .layer-list {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                    gap: 16px;
                    margin-bottom: 24px;
                }
                .layer-item {
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    padding: 12px 16px;
                    background: var(--bg-secondary);
                    border: 1px solid var(--border-primary);
                    border-radius: 10px;
                    transition: all 0.3s;
                }
                .layer-item:hover {
                    border-color: var(--accent-color);
                    background: var(--bg-tertiary);
                }
                .layer-item.selected {
                    border-color: var(--accent-color);
                    background: var(--accent-light);
                }
                .layer-name {
                    font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
                    font-size: 14px;
                    color: var(--text-primary);
                    font-weight: 500;
                }
                .layer-toggle {
                    width: 20px;
                    height: 20px;
                    border-radius: 4px;
                    border: 2px solid var(--border-primary);
                    background: transparent;
                    cursor: pointer;
                    transition: all 0.3s;
                    position: relative;
                }
                .layer-toggle.checked {
                    background: var(--accent-color);
                    border-color: var(--accent-color);
                }
                .layer-toggle.checked::after {
                    content: '‚úì';
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    color: white;
                    font-size: 12px;
                    font-weight: bold;
                }
                .editor-actions {
                    display: flex;
                    gap: 12px;
                    justify-content: flex-end;
                    padding-top: 20px;
                    border-top: 1px solid var(--border-primary);
                }
                .editor-btn {
                    padding: 12px 24px;
                    border-radius: 10px;
                    font-weight: 600;
                    cursor: pointer;
                    transition: all 0.3s;
                    border: none;
                    font-size: 14px;
                }
                .editor-btn-cancel {
                    background: var(--bg-secondary);
                    color: var(--text-secondary);
                    border: 1px solid var(--border-primary);
                }
                .editor-btn-cancel:hover {
                    background: var(--bg-tertiary);
                    color: var(--text-primary);
                }
                .editor-btn-add {
                    background: linear-gradient(135deg, var(--accent-color), var(--primary-color));
                    color: white;
                }
                .editor-btn-add:hover {
                    transform: translateY(-2px);
                    box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
                }
                </style>
            `;
            
            Object.keys(templates).forEach(category => {
                const templateList = templates[category];
                templatesHtml += `
                    <div class="template-category">
                        <h3 class="template-category-title">${category}</h3>
                        <div class="template-grid">
                            ${templateList.map(template => `
                                <div class="template-card" onclick="openTemplateEditor('${template.name}')">
                                    <div class="template-header">
                                        <div class="template-icon">${template.icon}</div>
                                        <div class="template-price">${template.price}</div>
                                    </div>
                                    <h3 class="template-title">${template.name}</h3>
                                    <p class="template-desc">${template.desc}</p>
                                    <div class="template-section">
                                        <span class="template-section-title">Features</span>
                                        ${template.features.map(feature => `<span class="feature-tag">‚Ä¢ ${feature}</span>`).join('')}
                                    </div>
                                    ${template.styles ? `
                                    <div class="template-section">
                                        <span class="template-section-title">CAD Styles Included</span>
                                        <div class="styles-grid">
                                            <div class="style-category">
                                                <span class="style-label">Text:</span>
                                                <span class="style-count">${template.styles.text ? template.styles.text.length : 0} styles</span>
                                            </div>
                                            <div class="style-category">
                                                <span class="style-label">Dimension:</span>
                                                <span class="style-count">${template.styles.dimension ? template.styles.dimension.length : 0} styles</span>
                                            </div>
                                            <div class="style-category">
                                                <span class="style-label">Surface:</span>
                                                <span class="style-count">${template.styles.surface ? template.styles.surface.length : 0} styles</span>
                                            </div>
                                            <div class="style-category">
                                                <span class="style-label">MLeader:</span>
                                                <span class="style-count">${template.styles.mleader ? template.styles.mleader.length : 0} styles</span>
                                            </div>
                                        </div>
                                    </div>
                                    ` : ''}
                                    <div class="template-section">
                                        <span class="template-section-title">Key Layers</span>
                                        <div>${template.layers.slice(0, 3).map(layer => `<code class="layer-code">${layer}</code>`).join('')}${template.layers.length > 3 ? `<span class="layer-more">+${template.layers.length - 3} more</span>` : ''}</div>
                                    </div>
                                    <div class="template-footer">
                                        <button class="template-customize-btn" onclick="event.stopPropagation(); openTemplateEditor('${template.name}')" title="Customize template">
                                            Customize & Add
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });
            
            // Replace the template types content with our new structure
            document.getElementById('templateTypes').innerHTML = templatesHtml;
        }

        let selectedTemplate = null;

        // Select template type
        function selectTemplateType(templateName, templateData) {
            selectedTemplate = templateData;
            
            // Update UI
            document.querySelectorAll('.template-type-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.target.closest('.template-type-card').classList.add('selected');
            
            // Show configuration panel
            document.getElementById('templateConfig').style.display = 'block';
            
            // Populate layer configuration
            populateLayerConfig(templateData.layers);
            
            // Update summary
            updateTemplateSummary();
        }

        // Populate layer configuration
        function populateLayerConfig(layers) {
            const layerConfig = document.getElementById('layerConfig');
            layerConfig.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                    ${layers.map(layer => `
                        <label style="display: flex; align-items: center; gap: 8px; padding: 8px; background: var(--bg-card); color: var(--text-primary); border-radius: 6px; border: 1px solid var(--border-primary);">
                            <input type="checkbox" checked> ${layer}
                        </label>
                    `).join('')}
                </div>
                <div style="margin-top: 16px;">
                    <input type="text" class="custom-input" placeholder="Add custom layer..." style="margin-bottom: 8px;">
                    <button type="button" class="custom-button" onclick="addCustomLayer()">Add Layer</button>
                </div>
            `;
        }

        // Add custom layer
        function addCustomLayer() {
            const input = document.querySelector('#layerConfig input[type="text"]');
            const layerName = input.value.trim();
            if (!layerName) return;
            
            const layerGrid = document.querySelector('#layerConfig div');
            layerGrid.innerHTML += `
                <label style="display: flex; align-items: center; gap: 8px; padding: 8px; background: var(--bg-card); color: var(--text-primary); border-radius: 6px; border: 1px solid var(--border-primary);">
                    <input type="checkbox" checked> ${layerName}
                </label>
            `;
            input.value = '';
            updateTemplateSummary();
        }

        // Update template summary
        function updateTemplateSummary() {
            if (!selectedTemplate) return;
            
            const summary = document.getElementById('templateSummary');
            const details = document.getElementById('templateDetails');
            
            const sheetSize = document.getElementById('sheetSize')?.value || 'ANSI D (22" x 34")';
            const scale = document.getElementById('drawingScale')?.value || '1" = 20\'';
            const units = document.getElementById('units')?.value || 'feet';
            
            const checkedLayers = Array.from(document.querySelectorAll('#layerConfig input[type="checkbox"]:checked'))
                .map(cb => cb.parentElement.textContent.trim());
            
            details.innerHTML = `
                <div style="background: var(--bg-card); color: var(--text-primary); border: 1px solid var(--border-primary); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                    <h4>Template: ${selectedTemplate.name}</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 12px;">
                        <div>
                            <strong>Drawing Setup:</strong><br>
                            Sheet Size: ${sheetSize}<br>
                            Scale: ${scale}<br>
                            Units: ${units}
                        </div>
                        <div>
                            <strong>Layers (${checkedLayers.length}):</strong><br>
                            ${checkedLayers.slice(0, 4).join(', ')}${checkedLayers.length > 4 ? '...' : ''}
                        </div>
                    </div>
                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e2e8f0;">
                        <strong>Total Price: ${selectedTemplate.price}</strong>
                    </div>
                </div>
            `;
            
            summary.style.display = 'block';
        }

        // Generate template
        function generateTemplate() {
            if (!selectedTemplate) return;
            
            selections.template++;
            updateSessionDisplay();
            
            goBack();
            addMessage(`Excellent! I've generated your ${selectedTemplate.name} template with ${document.querySelectorAll('#layerConfig input[type="checkbox"]:checked').length} layers. Your professional drawing template is ready for use.`, 'assistant', [
                'Download template file',
                'View layer specifications',
                'Create additional templates',
                'Get implementation guide'
            ]);
        }

        // Request custom template
        function requestCustomTemplate() {
            const requirements = document.querySelector('.custom-section textarea').value.trim();
            if (!requirements) return;
            
            selections.template++;
            updateSessionDisplay();
            
            goBack();
            addMessage(`Custom Template Request: "${requirements}"`, 'user');
            addMessage(`Perfect! I'll create a custom template based on your requirements: "${requirements}". Our team will design this specialized template with all necessary layers, standards, and configurations.`, 'assistant', [
                'Provide more specifications',
                'Review similar templates',
                'Get development timeline',
                'Submit this request'
            ]);
        }

        // Select LISP option
        function selectLispOption(lispName, lispPrice) {
            selections.lisp++;
            selectedItems.lisp.push({name: lispName, price: lispPrice});
            updateSessionDisplay();
            updateLispSummary();
        }

        // Select subassembly
        function selectSubassembly(subName, subPrice) {
            selections.subassembly++;
            selectedItems.subassembly.push({name: subName, price: subPrice});
            updateSessionDisplay();
            updateSubassemblySummary();
        }

        // Update LISP summary
        function updateLispSummary() {
            const summary = document.getElementById('lispSummary');
            const list = document.getElementById('lispSelectionList');
            
            if (selectedItems.lisp.length > 0) {
                summary.style.display = 'block';
                list.innerHTML = selectedItems.lisp.map(item => `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px; padding: 8px; background: var(--bg-card); color: var(--text-primary); border: 1px solid var(--border-primary); border-radius: 6px;">
                        <span>${item.name}</span>
                        <span style="font-weight: 600; color: var(--accent-primary);">${item.price}</span>
                    </div>
                `).join('');
            }
        }

        // Update Subassembly summary
        function updateSubassemblySummary() {
            const summary = document.getElementById('subassemblySummary');
            const list = document.getElementById('subassemblySelectionList');
            
            if (selectedItems.subassembly.length > 0) {
                summary.style.display = 'block';
                list.innerHTML = selectedItems.subassembly.map(item => `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px; padding: 8px; background: var(--bg-card); color: var(--text-primary); border: 1px solid var(--border-primary); border-radius: 6px;">
                        <span>${item.name}</span>
                        <span style="font-weight: 600; color: var(--accent-primary);">${item.price}</span>
                    </div>
                `).join('');
            }
        }

        // Complete selections
        function completeLispSelection() {
            goBack();
            addMessage(`Excellent! I've completed your LISP selection with ${selectedItems.lisp.length} routines. Your automation tools are ready for development.`, 'assistant', [
                'View my complete order',
                'Add more tools',
                'Proceed to checkout',
                'Get delivery timeline'
            ]);
        }

        function completeSubassemblySelection() {
            goBack();
            addMessage(`Perfect! Your corridor design is complete with ${selectedItems.subassembly.length} components. Your subassemblies are ready for deployment.`, 'assistant', [
                'Review corridor design',
                'Add more components',
                'Download assembly files',
                'Get installation guide'
            ]);
        }

        // Request custom LISP
        function requestCustomLisp() {
            const customRequest = document.getElementById('customLispInput').value.trim();
            if (!customRequest) return;
            
            selections.lisp++;
            selectedItems.lisp.push({name: `Custom: ${customRequest}`, price: "TBD"});
            updateSessionDisplay();
            updateLispSummary();
            document.getElementById('customLispInput').value = '';
        }

        // Request custom subassembly
        function requestCustomSubassembly() {
            const customRequest = document.getElementById('customSubInput').value.trim();
            if (!customRequest) return;
            
            selections.subassembly++;
            selectedItems.subassembly.push({name: `Custom: ${customRequest}`, price: "TBD"});
            updateSessionDisplay();
            updateSubassemblySummary();
            document.getElementById('customSubInput').value = '';
        }

        // Send to AI helper
        async function sendToAI(message) {
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message,
                        sessionId,
                        userId: 'web_user'
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.intent) {
                        currentIntent = result.intent;
                        updateSessionDisplay();
                    }
                }
            } catch (error) {
                console.log('AI processing failed, using local fallback');
            }
        }

        // Send message
        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;

            addMessage(message, 'user');
            messageInput.value = '';
            sendButton.disabled = true;
            loading.classList.add('show');

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message,
                        sessionId,
                        userId: 'web_user'
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    currentIntent = result.intent || currentIntent;
                    updateSessionDisplay();
                    addMessage(result.message, 'assistant', result.suggestions);
                } else {
                    addMessage('Sorry, I encountered an error. Please try again.', 'assistant');
                }
            } catch (error) {
                console.error('Error sending message:', error);
                addMessage('Connection error. Please check your internet connection and try again.', 'assistant');
            } finally {
                loading.classList.remove('show');
                sendButton.disabled = false;
                messageInput.focus();
            }
        }

        // Add message to chat
        function addMessage(content, sender, suggestions = []) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            if (sender === 'user') {
                messageDiv.innerHTML = `<div class="message-content">${content}</div>`;
            } else {
                let suggestionsHtml = '';
                if (suggestions && suggestions.length > 0) {
                    suggestionsHtml = `
                        <div style="margin-top: 12px;">
                            ${suggestions.map(s => `
                                <button onclick="sendSuggestion('${s}')" 
                                        style="background: #f1f5f9; border: 1px solid #cbd5e1; border-radius: 20px; 
                                               padding: 6px 12px; margin: 4px; font-size: 12px; cursor: pointer; 
                                               transition: all 0.2s;"
                                        onmouseover="this.style.background='#e2e8f0'"
                                        onmouseout="this.style.background='#f1f5f9'">
                                    ${s}
                                </button>
                            `).join('')}
                        </div>
                    `;
                }
                
                messageDiv.innerHTML = `
                    <div style="padding: 16px; background: var(--bg-card); color: var(--text-primary); border: 1px solid var(--border-primary); border-radius: 12px;">
                        ${content}
                        ${suggestionsHtml}
                    </div>
                `;
            }
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Send suggestion
        function sendSuggestion(text) {
            messageInput.value = text;
            sendMessage();
        }

        // Event listeners
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Dark mode toggle functionality
        let darkMode = true; // Default to dark mode

        function toggleTheme() {
            darkMode = !darkMode;
            const themeToggle = document.querySelector('.theme-toggle');
            
            if (darkMode) {
                themeToggle.textContent = 'üåô';
                themeToggle.title = 'Switch to Light Mode';
                // Reset to dark mode (default CSS variables)
                location.reload();
            } else {
                themeToggle.textContent = '‚òÄÔ∏è';
                themeToggle.title = 'Switch to Dark Mode';
                // Apply light mode
                document.documentElement.style.setProperty('--bg-primary', '#f8fafc');
                document.documentElement.style.setProperty('--bg-secondary', '#ffffff');
                document.documentElement.style.setProperty('--bg-card', '#ffffff');
                document.documentElement.style.setProperty('--bg-surface', '#f8fafc'); 
                document.documentElement.style.setProperty('--text-primary', '#1e293b');
                document.documentElement.style.setProperty('--text-secondary', '#475569');
                document.documentElement.style.setProperty('--text-muted', '#94a3b8');
                document.documentElement.style.setProperty('--border-primary', '#e2e8f0');
                document.documentElement.style.setProperty('--glass-bg', 'rgba(255, 255, 255, 0.8)');
                document.documentElement.style.setProperty('--glass-border', 'rgba(0, 0, 0, 0.1)');
                
                // Update body background for light mode
                document.body.style.backgroundImage = `
                    radial-gradient(at 40% 20%, rgba(59, 130, 246, 0.05) 0px, transparent 50%),
                    radial-gradient(at 80% 0%, rgba(139, 92, 246, 0.05) 0px, transparent 50%),
                    radial-gradient(at 0% 50%, rgba(16, 185, 129, 0.03) 0px, transparent 50%)
                `;
            }
        }

        // Enhanced card animations and professional features
        function addCardAnimations() {
            const cards = document.querySelectorAll('.option-card, .creator-card, .template-type-card');
            cards.forEach((card, index) => {
                card.style.animationDelay = `${index * 0.1}s`;
                
                // Add enhanced hover effects
                card.addEventListener('mouseenter', () => {
                    if (!card.classList.contains('selected')) {
                        card.style.transform = 'translateY(-6px) scale(1.02)';
                    }
                });
                
                card.addEventListener('mouseleave', () => {
                    if (!card.classList.contains('selected')) {
                        card.style.transform = 'translateY(0) scale(1)';
                    }
                });
            });
        }

        // Professional search functionality 
        function filterOptions(searchTerm) {
            const cards = document.querySelectorAll('.option-card, .creator-card');
            cards.forEach(card => {
                const title = card.querySelector('.card-title, .title, h4, h3')?.textContent.toLowerCase() || '';
                const desc = card.querySelector('.card-desc, .desc, p')?.textContent.toLowerCase() || '';
                const matches = title.includes(searchTerm.toLowerCase()) || desc.includes(searchTerm.toLowerCase());
                
                if (matches || searchTerm === '') {
                    card.style.display = '';
                    card.style.animation = 'fadeIn 0.3s ease-out';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        // Initialize professional features
        function initProfessionalFeatures() {
            setTimeout(() => {
                addCardAnimations();
                
                // Add any search functionality
                const searchBar = document.querySelector('.search-bar');
                if (searchBar) {
                    searchBar.addEventListener('input', (e) => filterOptions(e.target.value));
                }
                
                // Add enhanced button interactions
                const buttons = document.querySelectorAll('.custom-button, .proceed-button, .back-button');
                buttons.forEach(button => {
                    button.addEventListener('click', function() {
                        this.style.transform = 'scale(0.98)';
                        setTimeout(() => {
                            this.style.transform = '';
                        }, 150);
                    });
                });
            }, 100);
        }

        // Initialize
        initSession();
        messageInput.focus();
        updateSessionDisplay();
        initProfessionalFeatures();

        // Make cost estimator draggable
        function makeDraggable() {
            const costEstimator = document.getElementById('costEstimator');
            const header = costEstimator.querySelector('.cost-estimator-header');
            let isDragging = false;
            let currentX;
            let currentY;
            let initialX;
            let initialY;
            let xOffset = 0;
            let yOffset = 0;

            header.addEventListener('mousedown', dragStart);
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', dragEnd);

            function dragStart(e) {
                initialX = e.clientX - xOffset;
                initialY = e.clientY - yOffset;

                if (e.target === header || header.contains(e.target)) {
                    isDragging = true;
                    costEstimator.classList.add('dragging');
                }
            }

            function drag(e) {
                if (isDragging) {
                    e.preventDefault();
                    currentX = e.clientX - initialX;
                    currentY = e.clientY - initialY;

                    xOffset = currentX;
                    yOffset = currentY;

                    // Keep within viewport bounds
                    const rect = costEstimator.getBoundingClientRect();
                    const maxX = window.innerWidth - rect.width;
                    const maxY = window.innerHeight - rect.height;
                    
                    currentX = Math.max(0, Math.min(currentX, maxX));
                    currentY = Math.max(0, Math.min(currentY, maxY));

                    costEstimator.style.transform = `translate(${currentX}px, ${currentY}px)`;
                    costEstimator.style.right = 'auto';
                    costEstimator.style.top = 'auto';
                    costEstimator.style.left = '0';
                }
            }

            function dragEnd() {
                isDragging = false;
                costEstimator.classList.remove('dragging');
            }
        }

        makeDraggable();
        addMicroInteractions();
        initRemoveFunction();
        
        // Initialize variables at the top level
        if (typeof selectedItemsDetails === 'undefined') {
            window.selectedItemsDetails = [];
        }

        // Enhanced micro-interactions function
        function addMicroInteractions() {
            // Add staggered animation to creator cards
            document.querySelectorAll('.creator-card').forEach((card, index) => {
                card.style.animationDelay = `${index * 0.1}s`;
                
                // Enhanced hover effect
                card.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-8px) scale(1.03)';
                    this.style.boxShadow = '0 25px 50px rgba(0, 0, 0, 0.25)';
                });
                
                card.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0) scale(1)';
                    this.style.boxShadow = '';
                });
            });

            // Enhanced button interactions
            document.querySelectorAll('button').forEach(button => {
                button.addEventListener('mousedown', function() {
                    this.style.transform = 'scale(0.95)';
                });
                
                button.addEventListener('mouseup', function() {
                    this.style.transform = 'scale(1.05)';
                    setTimeout(() => {
                        this.style.transform = '';
                    }, 200);
                });
            });

            // Input focus animations
            document.querySelectorAll('input[type="text"]').forEach(input => {
                input.addEventListener('focus', function() {
                    this.style.transform = 'scale(1.02)';
                    this.style.boxShadow = '0 0 20px rgba(59, 130, 246, 0.3)';
                });
                
                input.addEventListener('blur', function() {
                    this.style.transform = 'scale(1)';
                    this.style.boxShadow = '';
                });
            });

            // Loading state for send button
            const sendButton = document.getElementById('sendButton');
            if (sendButton) {
                const originalSendMessage = window.sendMessage;
                window.sendMessage = function() {
                    sendButton.classList.add('button-loading');
                    sendButton.disabled = true;
                    
                    setTimeout(() => {
                        sendButton.classList.remove('button-loading');
                        sendButton.disabled = false;
                    }, 2000);
                    
                    if (originalSendMessage) {
                        originalSendMessage.call(this);
                    }
                };
            }
        }

        function initRemoveFunction() {
            // Initialize the selected items list
            updateSelectedItemsList();
        }

        function addSelectedItem(name, price, type, buttonElement) {
            // Initialize array if undefined
            if (!window.selectedItemsDetails) {
                window.selectedItemsDetails = [];
            }
            
            // Check if item already exists
            const existingItem = window.selectedItemsDetails.find(item => item.name === name && item.type === type);
            
            if (existingItem) {
                // Item already exists, don't add duplicate - show feedback
                showAddFeedback(buttonElement, 'Already Added!', '#f59e0b');
                return;
            } else {
                // Add new item
                const item = {
                    id: Date.now() + Math.random(),
                    name: name,
                    price: price,
                    type: type,
                    quantity: 1
                };
                
                window.selectedItemsDetails.push(item);
                showAddFeedback(buttonElement, 'Added!', '#10b981');
            }
            
            updateSelectedItemsList();
            updateTotalCost();
        }

        function showAddFeedback(button, message, color) {
            if (!button) return;
            
            const originalText = button.textContent;
            const originalColor = button.style.backgroundColor;
            
            button.textContent = message;
            button.style.backgroundColor = color;
            button.disabled = true;
            
            setTimeout(() => {
                button.textContent = originalText;
                button.style.backgroundColor = originalColor;
                button.disabled = false;
            }, 1500);
        }

        function removeSelectedItem(itemId, removeAll = true) {
            const itemIndex = window.selectedItemsDetails.findIndex(item => item.id === itemId);
            if (itemIndex !== -1) {
                // Remove entire item
                window.selectedItemsDetails.splice(itemIndex, 1);
                
                // Add removal animation
                const itemElement = document.querySelector(`[data-item-id="${itemId}"]`);
                if (itemElement) {
                    itemElement.style.animation = 'fadeOut 0.3s ease-out';
                    setTimeout(() => {
                        updateSelectedItemsList();
                        updateTotalCost();
                    }, 300);
                } else {
                    updateSelectedItemsList();
                    updateTotalCost();
                }
            }
        }

        function updateSelectedItemsList() {
            const selectedItemsContainer = document.getElementById('selectedItems');
            if (!selectedItemsContainer) return;

            // Initialize array if undefined
            if (!window.selectedItemsDetails) {
                window.selectedItemsDetails = [];
            }

            selectedItemsContainer.innerHTML = '';
            
            if (window.selectedItemsDetails.length === 0) {
                selectedItemsContainer.innerHTML = '<div style="text-align: center; color: var(--text-secondary); font-size: 12px; padding: 8px;">No items added</div>';
                return;
            }

            window.selectedItemsDetails.forEach(item => {
                const itemElement = document.createElement('div');
                itemElement.className = 'selected-item';
                itemElement.setAttribute('data-item-id', item.id);
                
                itemElement.innerHTML = `
                    <div class="item-info">
                        <div class="item-name">${item.name}</div>
                        <div class="item-price">$${item.price.toFixed(2)}</div>
                    </div>
                    <div class="item-controls">
                        <button class="remove-item" onclick="removeSelectedItem(${item.id}, true)" title="Remove item">√ó</button>
                    </div>
                `;
                
                selectedItemsContainer.appendChild(itemElement);
            });
        }

        function updateTotalCost() {
            // Initialize array if undefined
            if (!window.selectedItemsDetails) {
                window.selectedItemsDetails = [];
            }
            
            const total = window.selectedItemsDetails.reduce((sum, item) => sum + item.price, 0);
            const totalCostElement = document.getElementById('totalCost');
            if (totalCostElement) {
                totalCostElement.textContent = `$${total.toFixed(2)}`;
            }
        }

        // Demo function to add some items for testing
        function addDemoItems() {
            addSelectedItem('Quick Layer Creator (QLC)', 25.00, 'lisp', null);
            addSelectedItem('Surface Point Bomber (SPB)', 35.00, 'lisp', null);
            addSelectedItem('Batch Block Attribute Editor (BBAE)', 55.00, 'lisp', null);
        }

        // Function to add LISP tools from the provided list
        function addLispTool(toolName, price, buttonElement) {
            addSelectedItem(toolName, price, 'lisp', buttonElement);
        }

        // Function to add subassembly tools
        function addSubassemblyTool(toolName, price, buttonElement) {
            addSelectedItem(toolName, price, 'subassembly', buttonElement);
        }

        // Function to add template items
        function addTemplateItem(templateName, price, buttonElement) {
            addSelectedItem(templateName, price, 'template', buttonElement);
        }

        let currentTemplate = null;
        let selectedLayers = [];

        // Open template editor
        function openTemplateEditor(templateName) {
            // Find the template data from our templates object
            const templates = {
                "Essential Templates": [
                    {
                        name: "Minimal Template",
                        icon: "üìù",
                        desc: "Basic styles and Layer 0 only - simplest starting point",
                        features: ["Standard text styles", "Basic dimension styles", "Layer 0 setup", "Minimal plotting setup"],
                        layers: ["0 (Default layer)"],
                        price: "$25"
                    },
                    {
                        name: "Master Template", 
                        icon: "üè¢",
                        desc: "Comprehensive template with all AIA standard layers and styles",
                        features: ["All AIA standard layers", "Complete text/dimension styles", "Standard line weights", "Professional plotting setup"],
                        layers: ["All discipline layers (A-, C-, S-, M-, E-, P-, F-, L-)", "Complete annotation layers", "All standard layer combinations"],
                        price: "$125"
                    }
                ],
                "Project-Specific Templates": [
                    {
                        name: "Site Plan Template",
                        icon: "üó∫Ô∏è", 
                        desc: "Site planning layers for property boundaries, topography, and site features",
                        features: ["Property boundary layers", "Topographic elements", "Site features", "Landscape elements"],
                        layers: ["C-PROP (Property lines)", "C-TOPO (Topography)", "C-ROAD (Roads)", "L-PLNT (Planting)", "C-BLDG (Buildings)", "A-SITE (Site elements)"],
                        price: "$45"
                    },
                    {
                        name: "Existing Conditions Template",
                        icon: "üìã",
                        desc: "Survey and existing conditions with comprehensive documentation layers", 
                        features: ["Survey control points", "Existing utilities", "As-built documentation", "Field verification layers"],
                        layers: ["V-NTWK (Survey network)", "V-TOPO-E (Existing topography)", "C-UTIL-WATR-E (Existing water)", "C-UTIL-SEWR-E (Existing sewer)", "C-UTIL-ELEC-E (Existing electrical)", "V-PROP-BRNG (Property bearings)"],
                        price: "$55"
                    },
                    {
                        name: "Proposed Surface Template", 
                        icon: "üèóÔ∏è",
                        desc: "Everything needed for proposed surface design and grading",
                        features: ["Proposed grading", "Surface modeling", "Cut/fill analysis", "Earthwork calculations"],
                        layers: ["C-TOPO-N (Proposed contours)", "C-GRAD-N (Proposed grading)", "C-ROAD-PAVE-N (Proposed pavement)", "C-UTIL-STOM-N (Storm drainage)", "C-SITE-FEAT-N (Site features)"],
                        price: "$65"
                    }
                ],
                "Infrastructure Templates": [
                    {
                        name: "Drainage Template",
                        icon: "üåä",
                        desc: "Complete drainage design with storm systems and hydrology",
                        features: ["Storm drain systems", "Catch basins & inlets", "Retention/detention", "Hydrology calculations"],
                        layers: ["C-UTIL-STOM (Storm drainage)", "C-UTIL-STOM-PIPE (Storm pipes)", "C-UTIL-STOM-STRH (Storm structures)", "C-WATR (Water features)", "C-UTIL-STOM-LABL (Drainage labels)"],
                        price: "$75"
                    },
                    {
                        name: "Utilities Template",
                        icon: "‚ö°",
                        desc: "All utility systems - water, sewer, electrical, gas, telecom",
                        features: ["Water distribution", "Sewer collection", "Electrical systems", "Gas & telecom"],
                        layers: ["C-UTIL-WATR (Water)", "C-UTIL-SEWR (Sewer)", "E-POWR (Electrical power)", "C-UTIL-GAS (Gas)", "T-COMM (Telecommunications)", "C-UTIL-FIRE (Fire protection)"],
                        price: "$85"
                    }
                ],
                "Presentation Templates": [
                    {
                        name: "Plot Sheet Template",
                        icon: "üìÑ", 
                        desc: "Professional title blocks, borders, and presentation setup",
                        features: ["Standard title blocks", "Sheet borders", "Professional stamps", "Revision tracking"],
                        layers: ["G-ANNO-TTLB (Title block)", "G-ANNO-REVS (Revisions)", "G-ANNO-STMP (Professional stamp)", "G-ANNO-LOGO (Company logo)", "G-ANNO-NOTE (General notes)"],
                        price: "$35"
                    }
                ]
            };

            // Find the template by name
            currentTemplate = null;
            Object.values(templates).forEach(category => {
                const found = category.find(t => t.name === templateName);
                if (found) currentTemplate = found;
            });

            if (!currentTemplate) return;

            // Add styles to the current template
            currentTemplate.styles = generateStylesForTemplate(templateName);

            // Get all possible layers for this template type and select all by default
            const allLayers = getAllLayersForTemplate(templateName);
            selectedLayers = [...allLayers]; // Start with ALL layers selected
            
            document.getElementById('editorTitle').textContent = `Customize ${templateName}`;
            document.getElementById('editorSubtitle').textContent = currentTemplate.desc + " (All layers selected - uncheck what you don't need)";
            
            const layerListHtml = allLayers.map(layer => `
                <div class="layer-item selected">
                    <span class="layer-name">${layer}</span>
                    <div class="layer-toggle checked" 
                         onclick="toggleLayer('${layer}', this)"></div>
                </div>
            `).join('');
            
            document.getElementById('layerList').innerHTML = layerListHtml;
            
            // Always display CAD styles (now they're guaranteed to exist)
            displayCADStyles(currentTemplate.styles);
            
            // Show overlay with collision prevention
            const overlay = document.getElementById('templateEditorOverlay');
            const costEstimator = document.querySelector('.cost-estimator-float');
            
            overlay.classList.add('active');
            overlay.style.display = 'flex';
            
            // Dim the cost estimator to show editor has focus
            if (costEstimator) {
                costEstimator.classList.add('editor-open');
            }
            
            // Prevent body scroll when editor is open
            document.body.style.overflow = 'hidden';
            
            // Reset to layers tab when opening template
            switchTab('layers');
        }

        // Close template editor
        function closeTemplateEditor() {
            const overlay = document.getElementById('templateEditorOverlay');
            const costEstimator = document.querySelector('.cost-estimator-float');
            
            overlay.classList.remove('active');
            overlay.style.display = 'none';
            
            // Restore cost estimator visibility and interaction
            if (costEstimator) {
                costEstimator.classList.remove('editor-open');
            }
            
            // Restore body scroll
            document.body.style.overflow = '';
            
            currentTemplate = null;
            selectedLayers = [];
        }

        // Toggle layer selection
        function toggleLayer(layerName, toggleElement) {
            const layerItem = toggleElement.parentElement;
            
            if (selectedLayers.includes(layerName)) {
                selectedLayers = selectedLayers.filter(l => l !== layerName);
                toggleElement.classList.remove('checked');
                layerItem.classList.remove('selected');
            } else {
                selectedLayers.push(layerName);
                toggleElement.classList.add('checked');
                layerItem.classList.add('selected');
            }
        }

        // Add custom layer
        function addCustomLayer() {
            const input = document.getElementById('customLayerInput');
            const layerName = input.value.trim();
            
            if (!layerName) return;
            if (selectedLayers.includes(layerName)) {
                alert('Layer already exists');
                return;
            }
            
            selectedLayers.push(layerName);
            
            const layerListContainer = document.getElementById('layerList');
            const newLayerElement = document.createElement('div');
            newLayerElement.className = 'layer-item selected';
            newLayerElement.innerHTML = `
                <span class="layer-name">${layerName}</span>
                <div class="layer-toggle checked" onclick="toggleLayer('${layerName}', this)"></div>
            `;
            layerListContainer.appendChild(newLayerElement);
            
            input.value = '';
            
            // Scroll to the new layer
            newLayerElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // Add customized template to estimate
        function addCustomizedTemplate() {
            if (!currentTemplate || selectedLayers.length === 0) {
                alert('Please select at least one layer');
                return;
            }
            
            const layerCount = selectedLayers.length;
            const styleCount = Object.values(selectedStyles).reduce((sum, styles) => sum + styles.length, 0);
            const customizedName = `${currentTemplate.name} (${layerCount} layers, ${styleCount} styles)`;
            const basePrice = parseFloat(currentTemplate.price.replace('$', ''));
            const layerPrice = layerCount * 2; // $2 per layer
            const stylePrice = styleCount * 1; // $1 per style
            const totalPrice = basePrice + layerPrice + stylePrice;
            
            addSelectedItem(customizedName, totalPrice, 'template', null);
            closeTemplateEditor();
            
            // Show success feedback
            const costEstimator = document.querySelector('.cost-estimator-float');
            if (costEstimator) {
                costEstimator.style.transform = 'scale(1.05)';
                setTimeout(() => {
                    costEstimator.style.transform = 'scale(1)';
                }, 200);
            }
        }

        // Select all layers
        function selectAllLayers() {
            const layerItems = document.querySelectorAll('.layer-item');
            const allLayers = getAllLayersForTemplate(currentTemplate.name);
            selectedLayers = [...allLayers];
            
            layerItems.forEach(item => {
                item.classList.add('selected');
                item.querySelector('.layer-toggle').classList.add('checked');
            });
        }

        // Deselect all layers
        function deselectAllLayers() {
            const layerItems = document.querySelectorAll('.layer-item');
            selectedLayers = [];
            
            layerItems.forEach(item => {
                item.classList.remove('selected');
                item.querySelector('.layer-toggle').classList.remove('checked');
            });
        }

        // Get all possible layers for a template type
        function getAllLayersForTemplate(templateName) {
            const layerSets = {
                "Minimal Template": ["0"],
                "Master Template": [
                    "A-WALL", "A-DOOR", "A-WIND", "A-ROOF", "A-FLOR",
                    "C-PROP", "C-TOPO", "C-ROAD", "C-UTIL-WATR", "C-UTIL-SEWR", "C-UTIL-STOM",
                    "S-BEAM", "S-COLS", "S-FOUN", "S-SLAB",
                    "M-HVAC", "M-DUCT", "M-PIPE", "E-POWR", "E-LITE",
                    "P-FIXT", "P-PIPE", "F-SPKL", "L-PLNT", "L-IRRI",
                    "G-ANNO-TTLB", "G-ANNO-DIMS", "G-ANNO-TEXT", "G-ANNO-NOTE"
                ],
                "Site Plan Template": [
                    "C-PROP", "C-PROP-BRNG", "C-PROP-ESMT", "C-PROP-LINE",
                    "C-TOPO", "C-TOPO-MAJR", "C-TOPO-MINR", "C-TOPO-SPOT",
                    "C-ROAD", "C-ROAD-CNTR", "C-ROAD-CURB", "C-ROAD-PAVE",
                    "L-PLNT", "L-PLNT-TREE", "L-PLNT-SHRB", "L-PLNT-GRND",
                    "C-BLDG", "C-BLDG-OTLN", "C-BLDG-FOOT", "A-SITE", "A-SITE-PRKG"
                ],
                "Existing Conditions Template": [
                    "V-NTWK", "V-NTWK-CTRL", "V-NTWK-TRAV", "V-NTWK-BENC",
                    "V-TOPO-E", "V-TOPO-MAJR-E", "V-TOPO-MINR-E", "V-TOPO-SPOT-E",
                    "C-UTIL-WATR-E", "C-UTIL-SEWR-E", "C-UTIL-STOM-E", "C-UTIL-ELEC-E",
                    "C-UTIL-GAS-E", "T-COMM-E", "V-PROP-BRNG", "V-PROP-LINE-E",
                    "C-ROAD-E", "C-BLDG-E", "C-STRH-E"
                ],
                "Proposed Surface Template": [
                    "C-TOPO-N", "C-TOPO-MAJR-N", "C-TOPO-MINR-N", "C-TOPO-SPOT-N",
                    "C-GRAD-N", "C-GRAD-PLAN-N", "C-GRAD-SPOT-N", "C-GRAD-SWLE-N",
                    "C-ROAD-PAVE-N", "C-ROAD-CURB-N", "C-ROAD-CNTR-N", "C-ROAD-EDGE-N",
                    "C-UTIL-STOM-N", "C-UTIL-STOM-PIPE-N", "C-UTIL-STOM-STRH-N",
                    "C-SITE-FEAT-N", "C-SITE-PRKG-N", "C-SITE-WALK-N"
                ],
                "Drainage Template": [
                    "C-UTIL-STOM", "C-UTIL-STOM-PIPE", "C-UTIL-STOM-STRH", "C-UTIL-STOM-LABL",
                    "C-UTIL-STOM-CATC", "C-UTIL-STOM-INLT", "C-UTIL-STOM-OTFL", "C-UTIL-STOM-POND",
                    "C-WATR", "C-WATR-STRM", "C-WATR-LAKE", "C-WATR-WETL",
                    "C-TOPO-SHED", "C-TOPO-FLOW", "C-GRAD-SWLE", "C-GRAD-DITC"
                ],
                "Utilities Template": [
                    "C-UTIL-WATR", "C-UTIL-WATR-PIPE", "C-UTIL-WATR-STRH", "C-UTIL-WATR-SERV",
                    "C-UTIL-SEWR", "C-UTIL-SEWR-PIPE", "C-UTIL-SEWR-STRH", "C-UTIL-SEWR-SERV",
                    "E-POWR", "E-POWR-POLE", "E-POWR-LINE", "E-POWR-TRAN", "E-POWR-SERV",
                    "C-UTIL-GAS", "C-UTIL-GAS-PIPE", "C-UTIL-GAS-STRH", "C-UTIL-GAS-SERV",
                    "T-COMM", "T-COMM-CABL", "T-COMM-POLE", "T-COMM-DUCT",
                    "C-UTIL-FIRE", "C-UTIL-FIRE-HYDT"
                ],
                "Plot Sheet Template": [
                    "G-ANNO-TTLB", "G-ANNO-TTLB-LOGO", "G-ANNO-TTLB-TEXT", "G-ANNO-TTLB-LINE",
                    "G-ANNO-REVS", "G-ANNO-REVS-CLUD", "G-ANNO-REVS-TEXT", "G-ANNO-REVS-SYMB",
                    "G-ANNO-STMP", "G-ANNO-STMP-PROF", "G-ANNO-STMP-COMP", "G-ANNO-STMP-DATE",
                    "G-ANNO-LOGO", "G-ANNO-NOTE", "G-ANNO-NOTE-GENL", "G-ANNO-NOTE-LEGN"
                ]
            };
            
            return layerSets[templateName] || currentTemplate.layers;
        }

        let selectedStyles = {};

        // Switch between tabs
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // Show/hide content sections
            document.getElementById('layersSection').style.display = tabName === 'layers' ? 'block' : 'none';
            document.getElementById('stylesSection').style.display = tabName === 'styles' ? 'block' : 'none';
            
            // Show/hide custom layer section only for layers tab
            document.getElementById('customLayerSection').style.display = tabName === 'layers' ? 'block' : 'none';
            
            // If switching to styles tab, always reload them
            if (tabName === 'styles' && currentTemplate) {
                displayCADStyles(currentTemplate.styles);
            }
        }

        // Auto-populate missing template styles
        function populateTemplateStyles(templatesData) {
            // Add styles to templates that don't have them
            Object.keys(templatesData).forEach(categoryKey => {
                templatesData[categoryKey].forEach(template => {
                    if (!template.styles) {
                        // Add comprehensive CAD styles based on template type
                        template.styles = generateStylesForTemplate(template.name);
                    }
                });
            });
        }

        function generateStylesForTemplate(templateName) {
            const commonStyles = {
                text: [
                    "STANDARD (0.125\", Arial)", 
                    "ANNOTATIVE (Annotative, Arial)", 
                    "DECIMAL-2 (0.09\", 2 decimal places)", 
                    "ARIAL (0.125\", Arial font)", 
                    "SIMPLEX (0.125\", Simplex font)",
                    "TITLE (0.25\", Arial Bold)", 
                    "NOTE (0.08\", Simplex)", 
                    "LABEL (0.09\", Arial)",
                    "SPOT-ELEV (0.08\", Arial, 2 decimal)",
                    "ELEVATION-DOT (0.07\", with dot marker)",
                    "ELEVATION-LEADER (0.08\", with leader)",
                    "BEARINGS (0.08\", for property lines)",
                    "COORDINATES (0.07\", X,Y format)"
                ],
                dimension: [
                    "STANDARD (0.09\" text, Arial)", 
                    "ARCHITECTURAL (0.125\" text, Arial Bold)",
                    "CIVIL (0.09\" text, 2 decimal places)",
                    "ANNOTATIVE-DIM (Annotative scaling)",
                    "ELEVATION-DIM (Spot elevations)",
                    "BEARING-DIM (Property bearings)",
                    "COORDINATE-DIM (X,Y coordinates)"
                ],
                surface: [
                    "STANDARD (2' major, 1' minor contours)", 
                    "EXISTING (dashed, brown)",
                    "PROPOSED (solid, red)",
                    "DESIGN (solid, green)",
                    "SPOT-ELEVATIONS (point style with text)",
                    "FLOW-ARROWS (directional indicators)"
                ],
                mleader: [
                    "STANDARD (arrow, 0.09\" Arial)", 
                    "SPOT-ELEV-DOT (dot marker, elevation text)",
                    "SPOT-ELEV-LEADER (arrow leader, elevation)",
                    "NOTE (dot, 0.08\" Simplex)",
                    "DETAIL-BUBBLE (circle, detail reference)",
                    "SECTION-FLAG (flag, section marker)",
                    "ELEVATION-POINTER (triangle, elevation call-out)"
                ],
                plot: ["ANSI A-D", "Custom sizes", "ARCH sizes"],
                linetype: ["CONTINUOUS", "DASHED", "CENTER", "HIDDEN", "PROPERTY", "UTILITY"]
            };

            // Specialized styles for different template types
            if (templateName.includes("Site Plan")) {
                return {
                    text: [
                        "PROPERTY (0.09\" Arial Bold)", "PROPERTY-BEARING (0.08\" Arial, bearing format)", 
                        "TOPO-ELEV (0.08\" Arial, 2 decimal)", "SPOT-ELEV-DOT (0.07\" with dot)", 
                        "ROADS (0.1\" Arial)", "LANDSCAPE (0.07\" Simplex)", 
                        "BUILDING (0.125\" Arial Bold)", "SITE-LABEL (0.08\" Arial)",
                        "TREE-TAG (0.07\" Simplex)", "UTILITY-LABEL (0.08\" Arial)"
                    ],
                    dimension: [
                        "SITE-PLAN (0.09\" Arial, tick marks)", "PROPERTY-DIM (0.08\" bearings/distances)", 
                        "ELEVATION-DIM (0.07\" spot heights)", "LANDSCAPE-DIM (0.07\" plant sizes)",
                        "ANNOTATIVE-SITE (Annotative scaling)", "COORDINATE-DIM (X,Y format)"
                    ],
                    surface: [
                        "EXISTING-TOPO (brown dashed)", "PROPOSED-TOPO (red solid)", 
                        "SITE-FEATURES (black)", "LANDSCAPE (green)", 
                        "BUILDING-PAD (gray)", "PARKING (blue-gray)",
                        "SPOT-ELEV-POINTS (elevation markers)"
                    ],
                    mleader: [
                        "PROPERTY-NOTE (square marker)", "SPOT-ELEV-DOT (dot, elevation text)", 
                        "SPOT-ELEV-LEADER (arrow, elevation)", "SITE-LABEL (arrow)", 
                        "TREE-TAG (circle)", "BUILDING-LABEL (rectangle)", 
                        "UTILITY-ID (diamond)", "COORDINATE-LEADER (X,Y call-out)"
                    ],
                    plot: ["SITE-PLAN (24x36)", "DETAIL (11x17)", "PRESENTATION (30x42)", "LANDSCAPE (22x34)"],
                    linetype: ["PROPERTY-LINE", "EASEMENT", "RIGHT-OF-WAY", "SETBACK", "BUILDING-LINE", "LANDSCAPE-EDGE"]
                };
            } else if (templateName.includes("Proposed Surface")) {
                return {
                    text: [
                        "PROPOSED (0.09\" Arial Bold)", "GRADING-ELEV (0.08\" Arial, 2 decimal)", 
                        "SPOT-ELEV-DOT (0.07\" with dot marker)", "SPOT-ELEV-LEADER (0.08\" with leader)", 
                        "SLOPE-PCT (0.06\" percentage format)", "FINISH-FLOOR (0.08\" FF prefix)", 
                        "STATION (0.07\" chainage)", "BENCHMARK (0.08\" Arial Bold)",
                        "ANNOTATIVE-ELEV (Annotative scaling)", "COORDINATE-ELEV (X,Y,Z format)"
                    ],
                    dimension: [
                        "GRADING-DIM (0.09\" elevation, 2 decimal)", "SLOPE-DIM (0.08\" percentage)", 
                        "STATION-DIM (0.07\" chainage)", "CROSS-SECTION-DIM (0.08\" cuts)", 
                        "PROFILE-DIM (0.07\" vertical)", "ANNOTATIVE-GRADE (Annotative scaling)",
                        "ELEVATION-DIFFERENCE (cut/fill indicators)"
                    ],
                    surface: [
                        "PROPOSED-CONTOUR (red solid)", "FINISH-GRADE (green)", 
                        "SUBGRADE (orange)", "CUT-FILL (hatched)", 
                        "SLOPE-ANALYSIS (colored)", "EARTHWORK (brown)",
                        "SPOT-ELEVATION-POINTS (with elevation text)"
                    ],
                    mleader: [
                        "SPOT-ELEV-DOT (dot marker, elevation)", "SPOT-ELEV-LEADER (arrow, elevation)", 
                        "GRADE-BREAK (arrow)", "SLOPE-ARROW (triangle)", 
                        "FINISH-FLOOR (square)", "BENCHMARK (star)", 
                        "STATION-POINT (circle)", "COORDINATE-LEADER (X,Y,Z)"
                    ],
                    plot: ["GRADING-PLAN (30x42)", "SECTIONS (22x34)", "DETAILS (11x17)", "PROFILES (24x36)"],
                    linetype: ["PROPOSED", "FINISH-GRADE", "SUBGRADE", "SLOPE-LINE", "GRADE-BREAK", "CENTERLINE"]
                };
            } else if (templateName.includes("Drainage")) {
                return {
                    text: [
                        "STORM-ELEV (0.08\" Arial, 2 decimal)", "HYDRAULIC-DATA (0.07\" Simplex)", 
                        "FLOW-RATE (0.08\" Arial)", "CATCHMENT-AREA (0.09\" Arial Bold)",
                        "INVERT-ELEV (0.07\" Arial, 3 decimal)", "PIPE-SIZE (0.08\" Arial)",
                        "SPOT-ELEV-DOT (0.07\" with dot)", "STRUCTURE-ID (0.08\" Arial Bold)",
                        "ANNOTATIVE-STORM (Annotative scaling)"
                    ],
                    dimension: [
                        "PIPE-SIZE-DIM (0.08\" diameter)", "INVERT-DIM (0.07\" elevation, 3 decimal)", 
                        "SLOPE-DIM (0.06\" percentage)", "FLOW-RATE-DIM (0.08\" cfs/gpm)",
                        "ANNOTATIVE-PIPE (Annotative scaling)", "HYDRAULIC-DIM (technical data)"
                    ],
                    surface: [
                        "DRAINAGE-AREA (blue hatch)", "FLOW-DIRECTION (arrows)", 
                        "WATERSHED (boundary)", "POND-STORAGE (water level)",
                        "SPOT-INVERT-POINTS (invert elevation markers)"
                    ],
                    mleader: [
                        "STRUCTURE-ID (circle)", "PIPE-LABEL (arrow)", 
                        "INVERT-ELEV-DOT (dot, invert elevation)", "INVERT-ELEV-LEADER (arrow, invert)",
                        "FLOW-DATA (technical box)", "HYDRO-NOTE (info box)",
                        "SPOT-ELEV-LEADER (drainage elevation)"
                    ],
                    plot: ["DRAINAGE-PLAN (30x42)", "PROFILES (22x34)", "DETAILS (11x17)", "HYDRO-CALCS (8.5x11)"],
                    linetype: ["STORM-PIPE", "STORM-STRUCTURE", "FLOW-LINE", "DRAINAGE-BOUNDARY", "WATER-SURFACE"]
                };
            } else if (templateName.includes("Utilities")) {
                return {
                    text: [
                        "WATER-ELEV (0.08\" Arial, 2 decimal)", "SEWER-ELEV (0.08\" Arial, 2 decimal)", 
                        "ELECTRIC-VOLTAGE (0.08\" Arial)", "GAS-PRESSURE (0.08\" Arial)", 
                        "TELECOM-LABEL (0.07\" Simplex)", "FIRE-PRESSURE (0.08\" Arial Bold)",
                        "UTILITY-SIZE (0.08\" Arial)", "DEPTH-COVER (0.07\" Arial)",
                        "SPOT-ELEV-DOT (0.07\" with dot)", "ANNOTATIVE-UTILITY (Annotative scaling)"
                    ],
                    dimension: [
                        "PIPE-SIZE-DIM (0.08\" nominal)", "DEPTH-DIM (0.07\" cover)", 
                        "VOLTAGE-DIM (0.08\" electrical)", "PRESSURE-DIM (0.07\" psi)", 
                        "CAPACITY-DIM (0.08\" flow/load)", "ELEVATION-DIM (utility elevations)",
                        "ANNOTATIVE-UTIL-DIM (Annotative scaling)"
                    ],
                    surface: [
                        "UTILITY-CORRIDOR (hatched)", "EASEMENT (dashed)", 
                        "SERVICE-AREA (boundary)", "CONFLICT-ZONE (highlighted)",
                        "UTILITY-ELEVATION-POINTS (elevation markers)"
                    ],
                    mleader: [
                        "WATER-VALVE (circle)", "SEWER-MH (square)", 
                        "ELECTRIC-XFMR (triangle)", "GAS-METER (diamond)", 
                        "COMM-PEDESTAL (pentagon)", "FIRE-HYDRANT (star)",
                        "UTILITY-ELEV-DOT (dot, utility elevation)", "UTILITY-ELEV-LEADER (arrow, elevation)"
                    ],
                    plot: ["UTILITY-PLAN (24x36)", "PROFILES (22x34)", "DETAILS (11x17)", "SCHEDULES (8.5x11)"],
                    linetype: ["WATER-LINE", "SEWER-LINE", "ELECTRIC-LINE", "GAS-LINE", "TELECOM-LINE", "FIRE-LINE", "UTILITY-EASEMENT"]
                };
            } else if (templateName.includes("Plot Sheet")) {
                return {
                    text: [
                        "TITLE-BLOCK (0.125\" Arial Bold)", "SHEET-NUMBER (0.1875\" Arial Bold)", 
                        "PROJECT-NAME (0.25\" Arial Bold)", "REVISION (0.08\" Simplex)", 
                        "STAMP-TEXT (0.0625\" Arial)", "LOGO-TEXT (0.09\" Arial)",
                        "DATE-TEXT (0.08\" Arial)", "SCALE-TEXT (0.08\" Arial)",
                        "ANNOTATIVE-TITLE (Annotative scaling)"
                    ],
                    dimension: [
                        "SHEET-SIZE-DIM (border dimensions)", "TITLE-BLOCK-DIM (layout)", 
                        "STAMP-AREA-DIM (professional)", "ANNOTATIVE-SHEET (Annotative scaling)"
                    ],
                    surface: [
                        "TITLE-BLOCK (fill)", "BORDER (frame)", 
                        "REVISION-CLOUD (markup)", "STAMP-AREA (professional)"
                    ],
                    mleader: [
                        "REVISION-TRIANGLE (markup)", "STAMP-ARROW (professional)", 
                        "TITLE-POINTER (reference)", "DETAIL-REFERENCE (circular)",
                        "SECTION-REFERENCE (flag)", "ELEVATION-REFERENCE (square)"
                    ],
                    plot: ["ANSI A-E (all sizes)", "ARCH A-E (all sizes)", "ISO A0-A4", "CUSTOM (any size)"],
                    linetype: ["BORDER", "TITLE-BLOCK", "REVISION", "STAMP-LINE", "LOGO-FRAME"]
                };
            }
            
            return commonStyles;
        }

        // Display CAD styles in the editor (like layers with checkboxes)
        function displayCADStyles(styles) {
            const stylesContainer = document.getElementById('stylesDisplay');
            selectedStyles = {};
            let stylesHtml = '';
            
            Object.keys(styles).forEach(category => {
                const categoryStyles = styles[category];
                const categoryName = category.charAt(0).toUpperCase() + category.slice(1);
                selectedStyles[category] = [...categoryStyles]; // Start with all selected
                
                stylesHtml += `
                    <div style="margin-bottom: 24px;">
                        <h4 style="color: var(--text-primary); margin-bottom: 12px; padding-bottom: 6px; border-bottom: 1px solid var(--border-secondary);">${categoryName} Styles (${categoryStyles.length})</h4>
                        ${categoryStyles.map(style => `
                            <div class="layer-item selected">
                                <span class="layer-name">${style}</span>
                                <div class="layer-toggle checked" onclick="toggleStyle('${category}', '${style}', this)"></div>
                            </div>
                        `).join('')}
                    </div>
                `;
            });
            
            stylesContainer.innerHTML = stylesHtml;
        }

        // Toggle style selection (like layer toggles)
        function toggleStyle(category, styleName, toggleElement) {
            if (!selectedStyles[category]) selectedStyles[category] = [];
            
            const layerItem = toggleElement.parentElement;
            
            if (selectedStyles[category].includes(styleName)) {
                // Remove style
                selectedStyles[category] = selectedStyles[category].filter(s => s !== styleName);
                layerItem.classList.remove('selected');
                toggleElement.classList.remove('checked');
            } else {
                // Add style
                selectedStyles[category].push(styleName);
                layerItem.classList.add('selected');
                toggleElement.classList.add('checked');
            }
        }

        // Select all styles (like layers)
        function selectAllStyles() {
            if (!currentTemplate || !currentTemplate.styles) return;
            
            Object.keys(currentTemplate.styles).forEach(category => {
                selectedStyles[category] = [...currentTemplate.styles[category]];
            });
            
            document.querySelectorAll('#stylesDisplay .layer-item').forEach(item => {
                item.classList.add('selected');
                item.querySelector('.layer-toggle').classList.add('checked');
            });
        }

        // Deselect all styles (like layers)
        function deselectAllStyles() {
            selectedStyles = {};
            document.querySelectorAll('#stylesDisplay .layer-item').forEach(item => {
                item.classList.remove('selected');
                item.querySelector('.layer-toggle').classList.remove('checked');
            });
        }

        // Add demo items after a delay
        setTimeout(() => {
            addDemoItems();
        }, 2000);
    </script>
</body>
</html>